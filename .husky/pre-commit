#!/bin/sh

# Run existing pre-commit tasks
npx lint-staged

# Security: Scan for secrets using gitleaks (if installed)
if command -v gitleaks &> /dev/null; then
  echo "üîç Scanning for secrets..."
  gitleaks detect --source . --verbose --no-banner
  
  if [ $? -ne 0 ]; then
    echo "‚ùå Secret detected! Commit blocked."
    echo "üìù Review the files and remove any hardcoded secrets."
    echo "üí° Use environment variables instead."
    exit 1
  fi
  echo "‚úÖ No secrets detected"
else
  echo "‚ö†Ô∏è  Gitleaks not installed. Install with: brew install gitleaks"
  echo "   Or visit: https://github.com/gitleaks/gitleaks#installation"
fi

# Security: Check for common security patterns
echo "üîç Checking for security anti-patterns..."

# Check for hardcoded JWT patterns (excluding documentation)
if problematic_files=$(git diff --cached --name-only | grep -v "\.md$" | xargs grep -l -E "eyJ[A-Za-z0-9+/]{20,}={0,2}" 2>/dev/null); then
    echo "‚ùå Potential hardcoded JWT/token detected!"
    echo "   Use environment variables for all tokens and keys."
    echo "   Found in files:"
    echo "$problematic_files" | sed 's/^/   - /'
    exit 1
fi

# Check for console.log with potential sensitive data
if problematic_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(ts|tsx|js|jsx)$" | xargs grep -l -E "console\.(log|error|warn|info).*\b(password|token|secret|key|credential)" 2>/dev/null) && [ -n "$problematic_files" ]; then
    echo "‚ö†Ô∏è  Warning: console.log with potentially sensitive variable names detected"
    echo "   Make sure you're not logging sensitive information"
    echo "$problematic_files" | sed 's/^/   - /'
fi

echo "‚úÖ Security checks passed"
