# Story 7.7: Create Database Helper Functions

## Status

Approved

## Story

**As a** developer  
**I want** reusable functions for modal tracking and onboarding checks  
**So that** database operations are consistent and maintainable

## Acceptance Criteria

1. Create `lib/db/user-preferences.ts` with helper functions
2. `hasCompletedOnboarding(userId)` checks if roadmap_count > 0
3. `addShownModal(userId, stepId)` appends to shown_modals array
4. `hasShownModal(userId, stepId)` checks if modal was shown
5. All functions have proper TypeScript types
6. Functions handle errors gracefully

## Tasks / Subtasks

- [ ] Create user-preferences.ts file structure (AC: 1)
  - [ ] Create file at `lib/db/user-preferences.ts`
  - [ ] Import necessary Supabase client and types
  - [ ] Import database types from `lib/supabase/database.types.ts`
- [ ] Implement hasCompletedOnboarding function (AC: 2, 5, 6)
  - [ ] Define function signature returning boolean
  - [ ] Query users table for roadmap_count field
  - [ ] Return true if roadmap_count > 0, false otherwise
  - [ ] Handle errors with try/catch and return false on failure
- [ ] Implement addShownModal function (AC: 3, 5, 6)
  - [ ] Define function signature with userId and stepId params
  - [ ] Fetch current shown_modals array
  - [ ] Check if stepId already exists to avoid duplicates
  - [ ] Append stepId to JSONB array if not present
  - [ ] Update database with new array
  - [ ] Handle null/undefined shown_modals field initialization
- [ ] Implement hasShownModal function (AC: 4, 5, 6)
  - [ ] Define function signature returning boolean
  - [ ] Query shown_modals JSONB field
  - [ ] Check if stepId exists in array
  - [ ] Return true/false based on presence
  - [ ] Handle null/undefined shown_modals gracefully (return false)
- [ ] Add comprehensive TypeScript types
  - [ ] Define UserPreferences interface extending database types
  - [ ] Define PreferenceField union type for allowed fields
  - [ ] Add JSDoc comments for all public functions
  - [ ] Export all types and functions
- [ ] Write unit tests for all functions
  - [ ] Test hasCompletedOnboarding with various roadmap_count values
  - [ ] Test addShownModal with new and duplicate stepIds
  - [ ] Test hasShownModal with existing and non-existing stepIds
  - [ ] Test error handling for database failures

## Dev Notes

### Database Schema Reference

Based on the migration requirements and current database state:

**Existing fields to use:**

- `roadmap_count` INTEGER - Used to derive onboarding status (> 0 means completed)

**New field from Story 7.1:**

- `shown_modals` JSONB - Array to track shown modal IDs

### File Location

As per project structure [Source: docs/architecture/10-unified-project-structure.md], the helper functions should be created at:

```
/lib/db/user-preferences.ts
```

### TypeScript Types

All database types should be imported from the auto-generated types file [Source: docs/architecture/12-coding-standards.md#Database Type Usage Guide]:

```typescript
import type { User } from "@/lib/supabase/database.types";

// Example function signatures
export async function hasCompletedOnboarding(userId: string): Promise<boolean>;
export async function addShownModal(userId: string, stepId: string): Promise<boolean>;
export async function hasShownModal(userId: string, stepId: string): Promise<boolean>;
```

### Security Considerations

From [Source: docs/architecture/12-coding-standards.md#Security Standards]:

- Use Row-Level Security (RLS) - users can only update their own preferences
- Validate all inputs before database operations
- Never expose internal error details to the client
- Use proper error logging for debugging while returning generic errors

### Error Handling Pattern

Following the functional programming style [Source: docs/architecture/12-coding-standards.md#Core Principles]:

- Functions should be pure where possible
- Return null or default values on errors rather than throwing
- Log errors server-side for debugging
- Keep functions deterministic

### JSONB Operations for shown_modals

PostgreSQL JSONB operations required:

- Use `jsonb_array_elements` to check array contents
- Use array concatenation operator `||` to append new values
- Initialize as empty array `[]::jsonb` if null

### Testing Requirements

[Source: docs/architecture/11-testing-strategy.md]:

- Unit tests go in `/tests/unit/db/user-preferences.test.ts`
- Use Vitest for testing
- Mock Supabase client for isolated testing
- Test both happy and unhappy paths
- Include tests for error scenarios

## Testing

- Test file location: `/tests/unit/db/user-preferences.test.ts`
- Use Vitest with mocked Supabase client
- Test coverage for all functions including error cases
- Verify TypeScript types compile correctly
- Test JSONB array operations thoroughly

## Change Log

| Date       | Version | Description                                       | Author             |
| ---------- | ------- | ------------------------------------------------- | ------------------ |
| 2025-01-11 | 1.0     | Initial story creation                            | Bob (Scrum Master) |
| 2025-08-11 | 1.1     | Updated to use roadmap_count for onboarding check | Bob (Scrum Master) |
| 2025-08-11 | 1.2     | Removed theme functions - no UI for theme changes | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_To be filled by QA agent_
