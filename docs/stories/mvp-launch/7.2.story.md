# Story 7.2: Onboarding State Logic Update

## Status

Approved

## Story

**As a** user  
**I want** my onboarding status to be determined by my roadmap creation  
**So that** I have a consistent experience based on actual usage

## Acceptance Criteria

1. `NewRoadmapForm.tsx` checks `roadmap_count > 0` for onboarding status instead of localStorage
2. No dedicated onboarding field needed (uses existing `roadmap_count`)
3. User goal storage removed from localStorage (already stored in roadmaps table)
4. Tests updated to check roadmap count instead of localStorage
5. E2E tests pass with new implementation
6. Seamless fallback for users with existing localStorage data during transition

## Tasks / Subtasks

- [ ] Task 1: Create database helper function for onboarding status (AC: 1, 2)
  - [ ] Create or update `/lib/db/user-preferences.ts` file
  - [ ] Implement `hasCompletedOnboarding(userId: string)` function that checks `roadmap_count > 0`
  - [ ] Function should query users table for roadmap_count field
  - [ ] Add proper TypeScript types for return values
  - [ ] Include error handling with graceful fallbacks
- [ ] Task 2: Update NewRoadmapForm component to use database (AC: 1, 2, 3)
  - [ ] Import new database helper function
  - [ ] Replace localStorage.getItem('hasCompletedOnboarding') with hasCompletedOnboarding() check
  - [ ] Remove localStorage.setItem('hasCompletedOnboarding') - no longer needed
  - [ ] Remove localStorage.getItem/setItem for 'userGoal' (already in roadmaps table)
  - [ ] Add loading state while fetching onboarding status
- [ ] Task 3: Implement migration strategy for existing users (AC: 6)
  - [ ] Check localStorage for existing onboarding flag on component mount
  - [ ] If found in localStorage, migrate to database and clear localStorage
  - [ ] Log migration events for monitoring
  - [ ] Set up temporary dual-write pattern (write to both during transition)
  - [ ] Plan removal of migration code after transition period
- [ ] Task 4: Simplify onboarding completion flow (AC: 2)
  - [ ] Onboarding automatically completes when roadmap is created
  - [ ] No separate update needed (roadmap_count incremented by create_roadmap_with_tracking)
  - [ ] UI updates based on roadmap creation success
  - [ ] Show error toast if roadmap creation fails
  - [ ] Ensure UI state remains consistent
- [ ] Task 5: Update component tests (AC: 4)
  - [ ] Update `/tests/unit/components/new-roadmap.test.tsx`
  - [ ] Replace localStorage mocks with database function mocks
  - [ ] Test loading states during database fetch
  - [ ] Test error handling scenarios
  - [ ] Test migration path for existing localStorage data
- [ ] Task 6: Update E2E tests (AC: 5)
  - [ ] Update `/tests/e2e/roadmap-creation.spec.ts`
  - [ ] Remove localStorage assertions
  - [ ] Add database state verification
  - [ ] Test cross-device persistence (simulate multiple sessions)
  - [ ] Verify onboarding status persists after logout/login
- [ ] Task 7: Add monitoring and analytics (AC: 2, 6)
  - [ ] Add logging for onboarding completion events
  - [ ] Track migration from localStorage to database
  - [ ] Monitor database query performance
  - [ ] Set up alerts for failed updates
  - [ ] Create dashboard for onboarding metrics

## Dev Notes

### Previous Story Insights

**Story 7.1** creates the database schema with:

- `shown_modals` columns only
- RLS policies allowing users to update their own profile
- TypeScript types generated from database

**Note:** We're using existing `roadmap_count` field instead of adding `has_completed_onboarding`

### Architecture Context

**Component Location:** [Source: Epic 007 analysis]

- `/components/features/new-roadmap/NewRoadmapForm.tsx`
- Currently uses localStorage for state persistence

**Database Access Pattern:** [Source: architecture/10-unified-project-structure.md#31]

- Data Access Layer: `/lib/db/`
- All database operations go through this layer

**State Management:** [Source: architecture/2-tech-stack.md#11]

- Zustand for complex client-side state
- Only for transient UI state after this refactor

**Current localStorage Usage:** [Source: Epic 007#26-28]

```typescript
// Current implementation to replace
localStorage.getItem("hasCompletedOnboarding"); // Replace with roadmap_count check
localStorage.setItem("hasCompletedOnboarding", "true"); // Remove - automatic via roadmap creation
localStorage.getItem("userGoal"); // To be removed
```

**New Implementation:**

```typescript
// Check onboarding status via roadmap count
const hasCompleted = user.roadmap_count > 0;
```

**Roadmaps Table Schema:** [Source: architecture/7-database-schema.md#39-40]

```sql
CREATE TABLE "public"."roadmaps" (
  "id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  "user_id" uuid NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  "goal_description" text, -- User goal already stored here
  "status" roadmap_status DEFAULT 'active'::roadmap_status,
  "created_at" timestamptz DEFAULT now(),
  "completed_at" timestamptz
);
```

**Authentication Context:** [Source: architecture/2-tech-stack.md#14]

- Supabase Auth v2.0.0
- Provides auth.uid() for current user
- Integrates with RLS policies

### Frontend Alignment Notes

**User Flow:** [Source: prd.md#36-46]

- Onboarding is the entry point for new users
- Users define their goal which generates a roadmap
- Completion triggers transition to main app experience
- Must maintain smooth, uninterrupted flow

**Loading States:** [Source: frontend-spec.md]

- Use skeleton loaders during data fetch
- Maintain existing UI patterns
- Don't block user unnecessarily

**Error Handling:**

- Graceful fallbacks for database failures
- Never lose user's onboarding progress
- Clear error messages if issues occur

### Testing Requirements

[Source: architecture/11-testing-strategy.md]

- Unit tests for new database helper functions
- Integration tests for component-database interaction
- E2E tests for complete onboarding flow
- Migration path testing for existing users

**Test Scenarios:**

- New user onboarding flow
- Returning user recognition
- Cross-device persistence
- Migration from localStorage
- Database failure handling

### Migration Strategy

**Phase 1: Dual Write (2 weeks)**

- Write to both localStorage and database
- Read from database, fallback to localStorage
- Monitor for issues

**Phase 2: Database Primary (2 weeks)**

- Read primarily from database
- Migrate localStorage data on detection
- Keep localStorage as emergency fallback

**Phase 3: Cleanup (after 1 month)**

- Remove localStorage code
- Remove migration logic
- Database as single source of truth

### Security Considerations

- No sensitive data in onboarding status
- RLS policies ensure user isolation
- No cross-user data leakage
- Audit trail for status changes

## Change Log

| Date       | Version | Description                                             | Author             |
| ---------- | ------- | ------------------------------------------------------- | ------------------ |
| 2025-08-11 | 1.0     | Initial story creation from Epic 7                      | Bob (Scrum Master) |
| 2025-08-11 | 1.1     | Updated to use roadmap_count instead of dedicated field | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

[To be populated by dev agent]

### Debug Log References

[To be populated by dev agent]

### Completion Notes List

[To be populated by dev agent]

### File List

[To be populated by dev agent]

## QA Results

[To be populated by QA agent]
