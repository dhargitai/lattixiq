# Story 5.1: Resend Integration Setup

## Status

Approved

## Story

**As a** system administrator,
**I want** Resend email service properly configured,
**so that** the application can send reliable transactional emails

## Acceptance Criteria

1. Install and configure Resend Node.js SDK
2. Set up environment variables for Resend API key
3. Create email service utility functions
4. Implement error handling and retry logic
5. Test email sending functionality in development environment
6. Set up email delivery monitoring and logging

## Tasks / Subtasks

- [ ] Install Resend SDK package (AC: 1)
  - [ ] Run `npm install resend`
  - [ ] Add Resend to package.json dependencies
  - [ ] Verify installation and TypeScript types

- [ ] Configure environment variables (AC: 2)
  - [ ] Add RESEND_API_KEY to .env.local
  - [ ] Add RESEND_FROM_EMAIL to .env.local
  - [ ] Update .env.example with placeholder values
  - [ ] Add validation for required env vars in email service

- [ ] Create email service module (AC: 3)
  - [ ] Create `/lib/email/` directory per project structure
  - [ ] Create `/lib/email/resend-client.ts` for Resend client initialization
  - [ ] Create `/lib/email/send-email.ts` with main sending function
  - [ ] Add TypeScript interfaces for email parameters
  - [ ] Follow functional programming patterns from coding standards

- [ ] Implement error handling and retry logic (AC: 4)
  - [ ] Add try-catch blocks with proper error logging
  - [ ] Implement exponential backoff retry mechanism
  - [ ] Create fallback behavior if email fails
  - [ ] Ensure errors don't leak sensitive information per security standards

- [ ] Create development testing utilities (AC: 5)
  - [ ] Create test endpoint at `/api/test-email/route.ts` (dev only)
  - [ ] Add email preview functionality for development
  - [ ] Test with various email providers (Gmail, Outlook)
  - [ ] Verify email delivery in Resend dashboard

- [ ] Implement logging and monitoring (AC: 6)
  - [ ] Add email sending logs to notification_logs table
  - [ ] Track delivery status, timestamps, and errors
  - [ ] Create monitoring utilities for tracking delivery rates
  - [ ] Ensure logs don't contain sensitive user data

- [ ] Add unit tests (per Testing Strategy)
  - [ ] Create `/tests/unit/email/resend-client.test.ts`
  - [ ] Test email service initialization
  - [ ] Test error handling scenarios
  - [ ] Mock Resend API calls using Vitest

- [ ] Add integration tests (per Testing Strategy)
  - [ ] Create `/tests/integration/email/send-email.test.ts`
  - [ ] Test complete email sending flow with mocked Resend
  - [ ] Test retry logic and error scenarios
  - [ ] Verify logging functionality

## Dev Notes

### Previous Story Insights

No previous story directly related to email integration.

### Data Models

**notification_logs table** - Used for tracking email delivery

- `id`: UUID primary key
- `user_id`: Foreign key to users table
- `type`: Notification type (will include 'email')
- `status`: Delivery status
- `sent_at`: Timestamp of send attempt
- `error`: Error message if failed
  [Source: architecture/7-database-schema.md]

### API Specifications

No existing email API endpoints. Will create new utilities in `/lib/email/` directory.
[Source: architecture/10-unified-project-structure.md#lib]

### Component Specifications

Not applicable - backend service only.

### Frontend Alignment

Not applicable - backend service only.

### File Locations

Based on project structure:

- `/lib/email/` - New directory for email utilities
- `/lib/email/resend-client.ts` - Resend client initialization
- `/lib/email/send-email.ts` - Main email sending function
- `/tests/unit/email/` - Unit tests
- `/tests/integration/email/` - Integration tests
  [Source: architecture/10-unified-project-structure.md]

### Testing Requirements

- Follow TDD approach: Red-Green-Refactor cycle
- Mock all external services (Resend) using Vitest
- Test both happy and unhappy paths
- Use separate test database via .env.test
  [Source: architecture/11-testing-strategy.md]

### Technical Constraints

- **Security**: Never hardcode API keys - use environment variables
- **Security**: Service role keys only in server-side context
- **Security**: Implement proper error handling without leaking sensitive info
- **Coding Standards**: Follow functional programming patterns
- **Coding Standards**: Use camelCase for functions/variables
- **Tech Stack**: Notification service is "To be determined" but should be abstracted
  [Source: architecture/12-coding-standards.md#security-standards]
  [Source: architecture/2-tech-stack.md#notifications]

### Integration with Existing Cron Job

The existing reminder cron job is located at `/app/api/notifications/cron/route.ts`. This cron job:

- Runs periodically to check for users with reminders enabled
- Filters users based on timezone and reminder time
- Currently only handles browser notifications
- Email sending will be integrated alongside existing notification logic
  [Source: app/api/notifications/cron/route.ts]

## Testing

- Unit tests in `/tests/unit/email/` for Resend client and utilities
- Integration tests in `/tests/integration/email/` for complete flow
- Mock Resend API calls to avoid external dependencies
- Test error scenarios including API failures and invalid emails
- Verify environment variable validation

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-08-10 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
