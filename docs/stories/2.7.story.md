# Story 2.7: Create Progress Tracking Dashboard - Motivational Learning Journey Visualization

## Status

Draft

## Story

**As a** user who has been using the app to learn mental models and biases
**I want** to see a comprehensive dashboard of my learning progress and achievements
**So that** I stay motivated, understand my growth, and can identify which techniques work best for me

## Acceptance Criteria

1. Dashboard displays current streak of consecutive days with reflections
2. Shows total count of completed reflections across all roadmaps
3. Current roadmap progress bar shows completion percentage and steps completed/total
4. Most effective models section highlights top 3 mental models/biases by effectiveness rating
5. Recent reflections preview shows last 5 reflection entries with date and model name
6. Dashboard is accessible from main navigation menu with "Progress" label
7. All metrics update in real-time when new reflections are completed
8. Loading states show skeleton placeholders while data fetches
9. Empty states display encouraging messages when no data exists yet
10. Mobile-responsive design with proper layout on all screen sizes
11. Streak calculation handles timezone differences and displays flame icon
12. Error handling gracefully manages data fetch failures with retry options
13. Effectiveness ratings display as star ratings with average calculations
14. Recent reflections are clickable and link to the original reflection details
15. Performance optimized with data caching and efficient database queries

## Tasks / Subtasks

- [ ] Task 1: Write integration tests using TDD approach (AC: 1-15)
  - [ ] Create test file at `/components/features/progress/__tests__/progress-dashboard.test.tsx`
  - [ ] Write test for streak calculation with various scenarios:
    - New user with no reflections (streak = 0)
    - User with daily reflections (streak = current count)
    - User with missed days (streak resets)
    - User with reflections across timezone changes
  - [ ] Write test for reflection count aggregation across all roadmaps
  - [ ] Write test for roadmap progress calculation (completed/total steps)
  - [ ] Write test for effectiveness rating calculations and top models selection
  - [ ] Write test for recent reflections display and formatting
  - [ ] Write test for loading states and skeleton components
  - [ ] Write test for empty states with no data
  - [ ] Write test for error handling and retry functionality
  - [ ] Write test for mobile responsive behavior
  - [ ] Write test for navigation integration and accessibility
  - [ ] Write test for real-time updates when new reflections are added

- [ ] Task 2: Create progress metrics queries and utilities (AC: 1, 2, 3, 4, 7)
  - [ ] Create `/lib/queries/progress-queries.ts` with comprehensive metrics functions:

    ```typescript
    export async function calculateCurrentStreak(userId: string): Promise<number> {
      // Calculate consecutive days with reflections from today backwards
      // Handle timezone differences using user's timezone
      // Return 0 for new users, current streak for active users
    }

    export async function getTotalReflectionCount(userId: string): Promise<number> {
      // Count all completed reflections across all roadmaps
      // Exclude incomplete or draft reflections
    }

    export async function getCurrentRoadmapProgress(userId: string): Promise<{
      completedSteps: number;
      totalSteps: number;
      progressPercentage: number;
      roadmapTitle: string;
    } | null> {
      // Get active roadmap and calculate completion percentage
      // Handle case where user has no active roadmap
    }

    export async function getMostEffectiveModels(userId: string): Promise<
      Array<{
        id: string;
        title: string;
        type: KnowledgeContentType;
        averageRating: number;
        reflectionCount: number;
      }>
    > {
      // Get top 3 models by average effectiveness rating
      // Minimum 1 reflection to be included
      // Sort by rating, then by reflection count
    }

    export async function getRecentReflections(userId: string): Promise<
      Array<{
        id: string;
        createdAt: string;
        modelTitle: string;
        modelType: KnowledgeContentType;
        effectivenessRating: number;
        situationText: string;
        roadmapStepId: string;
      }>
    > {
      // Get last 5 reflections with related model information
      // Include enough data for preview display
    }
    ```

  - [ ] Add timezone handling utilities in `/lib/utils/date-utils.ts`
  - [ ] Implement efficient caching strategy for expensive calculations
  - [ ] Add data validation and error handling for all query functions

- [ ] Task 3: Create ProgressDashboard main component (AC: 1-15)
  - [ ] Create `/components/features/progress/ProgressDashboard.tsx` with comprehensive layout:

    ```typescript
    interface ProgressMetrics {
      currentStreak: number;
      totalReflections: number;
      roadmapProgress: {
        completedSteps: number;
        totalSteps: number;
        progressPercentage: number;
        roadmapTitle: string;
      } | null;
      topModels: Array<{
        id: string;
        title: string;
        type: KnowledgeContentType;
        averageRating: number;
        reflectionCount: number;
      }>;
      recentReflections: Array<{
        id: string;
        createdAt: string;
        modelTitle: string;
        modelType: KnowledgeContentType;
        effectivenessRating: number;
        situationText: string;
        roadmapStepId: string;
      }>;
    }

    interface ProgressDashboardProps extends React.HTMLAttributes<HTMLDivElement> {
      userId: string;
    }
    ```

  - [ ] Implement responsive grid layout with sections:
    - Header with page title and motivation message
    - Stats cards row (streak, total reflections, current progress)
    - Most effective models section with cards
    - Recent reflections list with preview
  - [ ] Add proper error boundaries and loading states
  - [ ] Implement real-time data updates with SWR or similar
  - [ ] Follow established component patterns with forwardRef

- [ ] Task 4: Create StreakCard component (AC: 1, 11)
  - [ ] Create `/components/features/progress/StreakCard.tsx` with flame icon:
    ```typescript
    interface StreakCardProps {
      currentStreak: number;
      loading?: boolean;
    }
    ```
  - [ ] Design flame icon with dynamic styling based on streak:
    - 0 days: Gray flame with encouraging message
    - 1-7 days: Orange flame with "Getting started!"
    - 8-30 days: Red flame with "On fire!"
    - 31+ days: Blue flame with "Unstoppable!"
  - [ ] Add streak milestone celebrations
  - [ ] Include motivational text for different streak levels
  - [ ] Implement smooth animations for streak updates

- [ ] Task 5: Create ReflectionStatsCard component (AC: 2)
  - [ ] Create `/components/features/progress/ReflectionStatsCard.tsx`:
    ```typescript
    interface ReflectionStatsCardProps {
      totalCount: number;
      loading?: boolean;
    }
    ```
  - [ ] Display total reflection count with proper formatting
  - [ ] Add milestone achievements (5, 10, 25, 50, 100 reflections)
  - [ ] Include progress indicators for next milestone
  - [ ] Design celebratory styling for milestone achievements

- [ ] Task 6: Create RoadmapProgressCard component (AC: 3)
  - [ ] Create `/components/features/progress/RoadmapProgressCard.tsx`:
    ```typescript
    interface RoadmapProgressCardProps {
      progress: {
        completedSteps: number;
        totalSteps: number;
        progressPercentage: number;
        roadmapTitle: string;
      } | null;
      loading?: boolean;
    }
    ```
  - [ ] Use existing Progress component for visual progress bar
  - [ ] Display roadmap title, steps completed/total, percentage
  - [ ] Handle empty state when no active roadmap exists
  - [ ] Add "View Roadmap" link for navigation to roadmap screen
  - [ ] Include next step preview or completion celebration

- [ ] Task 7: Create EffectiveModelsSection component (AC: 4, 13)
  - [ ] Create `/components/features/progress/EffectiveModelsSection.tsx`:

    ```typescript
    interface EffectiveModel {
      id: string;
      title: string;
      type: KnowledgeContentType;
      averageRating: number;
      reflectionCount: number;
    }

    interface EffectiveModelsSectionProps {
      models: EffectiveModel[];
      loading?: boolean;
    }
    ```

  - [ ] Display top 3 models in card layout with:
    - Model title and type badge
    - Star rating display (average effectiveness)
    - Number of times reflected on
    - Brief description of why this model works
  - [ ] Handle empty state with encouraging message to continue learning
  - [ ] Add hover effects and potential navigation to model details
  - [ ] Include methodology explanation for how effectiveness is calculated

- [ ] Task 8: Create RecentReflectionsSection component (AC: 5, 14)
  - [ ] Create `/components/features/progress/RecentReflectionsSection.tsx`:

    ```typescript
    interface RecentReflection {
      id: string;
      createdAt: string;
      modelTitle: string;
      modelType: KnowledgeContentType;
      effectivenessRating: number;
      situationText: string;
      roadmapStepId: string;
    }

    interface RecentReflectionsSectionProps {
      reflections: RecentReflection[];
      loading?: boolean;
    }
    ```

  - [ ] Display list of recent reflections with:
    - Date formatted as "2 days ago", "1 week ago"
    - Model name with type badge
    - Effectiveness rating as stars
    - Truncated situation text (first 100 characters)
    - Click handler to navigate to full reflection
  - [ ] Add "View All Reflections" link for comprehensive reflection history
  - [ ] Handle empty state for new users
  - [ ] Implement smooth animations for list updates

- [ ] Task 9: Create progress dashboard route and page (AC: 6, 8, 12)
  - [ ] Create `/app/(app)/progress/page.tsx` with authentication and data fetching:
    ```typescript
    export default async function ProgressPage() {
      // Check authentication
      // Fetch all progress metrics server-side
      // Handle loading and error states
      // Render ProgressDashboard with data
    }
    ```
  - [ ] Create `/app/(app)/progress/loading.tsx` with comprehensive skeleton
  - [ ] Create `/app/(app)/progress/error.tsx` with retry functionality
  - [ ] Add proper metadata and SEO optimization
  - [ ] Implement data revalidation strategy

- [ ] Task 10: Create skeleton components for loading states (AC: 8)
  - [ ] Create `/components/features/progress/ProgressDashboardSkeleton.tsx`
  - [ ] Create individual skeleton components:
    - StreakCardSkeleton
    - ReflectionStatsCardSkeleton
    - RoadmapProgressCardSkeleton
    - EffectiveModelsSectionSkeleton
    - RecentReflectionsSectionSkeleton
  - [ ] Match actual component layouts for seamless transitions
  - [ ] Add proper animation and shimmer effects
  - [ ] Ensure accessibility with proper ARIA labels

- [ ] Task 11: Create empty state components (AC: 9)
  - [ ] Create `/components/features/progress/EmptyProgressState.tsx` for new users:
    ```typescript
    interface EmptyProgressStateProps {
      hasRoadmap: boolean;
      userName?: string;
    }
    ```
  - [ ] Design encouraging empty states:
    - No roadmap: "Start your learning journey"
    - No reflections: "Complete your first reflection to see progress"
    - No effective models yet: "Keep reflecting to discover your most effective techniques"
  - [ ] Include clear call-to-action buttons
  - [ ] Add motivational illustrations or icons
  - [ ] Provide helpful onboarding tips

- [ ] Task 12: Integrate with navigation system (AC: 6)
  - [ ] Update main navigation to include "Progress" menu item
  - [ ] Add progress icon (chart or dashboard icon)
  - [ ] Update navigation state management if needed
  - [ ] Add breadcrumb support for progress page
  - [ ] Ensure navigation highlighting works correctly
  - [ ] Test navigation flow from various app sections

- [ ] Task 13: Implement real-time updates and caching (AC: 7, 15)
  - [ ] Set up SWR or React Query for progress data
  - [ ] Implement cache invalidation when new reflections are completed
  - [ ] Add optimistic updates for immediate feedback
  - [ ] Create cache warming strategy for expensive calculations
  - [ ] Add background data refresh for active users
  - [ ] Implement proper error recovery and retry logic

- [ ] Task 14: Add performance optimizations (AC: 15)
  - [ ] Implement database query optimization:
    - Use database indexes for date-based queries
    - Aggregate queries where possible
    - Limit result sets appropriately
  - [ ] Add React component optimizations:
    - Memoize expensive calculations
    - Use React.memo for stable components
    - Implement virtualization if needed for large lists
  - [ ] Set up monitoring for dashboard load times
  - [ ] Add performance budgets and alerts

- [ ] Task 15: Enhanced accessibility and mobile experience (AC: 10)
  - [ ] Ensure all components have proper ARIA labels
  - [ ] Add keyboard navigation support
  - [ ] Test with screen readers
  - [ ] Verify color contrast ratios meet WCAG AA standards
  - [ ] Optimize touch targets for mobile devices
  - [ ] Test responsive behavior across device sizes
  - [ ] Add haptic feedback for mobile interactions

- [ ] Task 16: Add analytics and user insights (AC: 7)
  - [ ] Track dashboard page views and engagement
  - [ ] Monitor which sections users interact with most
  - [ ] Add A/B testing framework for dashboard improvements
  - [ ] Track streak milestone achievements
  - [ ] Monitor dashboard load performance
  - [ ] Set up alerts for unusual user behavior patterns

- [ ] Task 17: Verify all tests pass and dashboard functions correctly (AC: 1-15)
  - [ ] Run full test suite with all progress dashboard tests
  - [ ] Test complete user journeys:
    - New user with no data (empty states)
    - Active user with partial progress
    - Advanced user with complete roadmaps and long streaks
  - [ ] Test edge cases:
    - Network failures and recovery
    - Invalid data handling
    - Timezone edge cases
    - Large datasets performance
  - [ ] Cross-browser compatibility testing
  - [ ] Mobile device testing on iOS and Android
  - [ ] User acceptance testing with real users
  - [ ] Performance testing under load
  - [ ] Accessibility testing with assistive technologies

## Dev Notes

### Previous Story Insights

From Story 2.1 (Learn Screen):

- Component patterns established with forwardRef and TypeScript interfaces
- Loading states implemented via Next.js patterns (loading.tsx)
- Authentication and data fetching patterns established
- Database queries use snake_case field names directly

From Story 2.5 (Reflect Screen):

- ApplicationLog table stores reflection data with effectiveness_rating
- Reflections have created_at timestamps for streak calculations
- effectiveness_rating is 1-5 scale suitable for star displays
- Reflection completion unlocks next roadmap step

From Epic 2 requirements:

- Story 2.7 has 5 story points (medium complexity)
- Progress tracking is essential for user motivation and retention
- Must integrate seamlessly with existing navigation
- Should encourage continued engagement

### Architecture Requirements

**Dashboard Layout Strategy:**
Following mobile-first responsive design:

- Single column on mobile with stacked sections
- Two-column grid on tablet (stats cards side by side)
- Three-column grid on desktop with sidebar potential
- Consistent spacing and typography with existing app

**Data Architecture:**
Progress metrics calculated from existing tables:

```sql
-- Streak calculation query pattern
SELECT DATE(created_at) as reflection_date
FROM application_logs
WHERE user_id = $1
ORDER BY reflection_date DESC;

-- Effectiveness calculation query pattern
SELECT kc.title, kc.type, AVG(al.effectiveness_rating) as avg_rating
FROM application_logs al
JOIN roadmap_steps rs ON al.roadmap_step_id = rs.id
JOIN knowledge_content kc ON rs.knowledge_content_id = kc.id
WHERE al.user_id = $1 AND al.effectiveness_rating IS NOT NULL
GROUP BY kc.id, kc.title, kc.type
ORDER BY avg_rating DESC, COUNT(*) DESC
LIMIT 3;
```

**Route Structure:**
New route at `/app/(app)/progress/` matching existing patterns:

```text
/app/(app)/progress/
├── page.tsx           # Main progress dashboard page
├── loading.tsx        # Loading skeleton
├── error.tsx          # Error boundary with retry
└── __tests__/         # Integration tests
    └── progress.test.tsx
```

### Component Architecture

**Component Hierarchy:**

```text
ProgressDashboard (main container)
├── ProgressHeader (title and motivation)
├── StatsGrid (responsive layout)
│   ├── StreakCard (flame icon, streak count)
│   ├── ReflectionStatsCard (total count, milestones)
│   └── RoadmapProgressCard (progress bar, next step)
├── EffectiveModelsSection (top 3 models)
│   └── EffectiveModelCard[] (rating stars, details)
└── RecentReflectionsSection (last 5 reflections)
    └── RecentReflectionItem[] (clickable previews)
```

**Reusable Components:**

- Use existing Progress component for roadmap progress
- Use existing Star Rating pattern for effectiveness display
- Follow established Card patterns for consistent styling
- Implement proper loading skeletons matching content structure

### Data Models

**Progress Metrics Interface:**

```typescript
interface ProgressDashboardData {
  currentStreak: number;
  totalReflections: number;
  roadmapProgress: {
    completedSteps: number;
    totalSteps: number;
    progressPercentage: number;
    roadmapTitle: string;
    nextStepTitle?: string;
  } | null;
  topModels: Array<{
    id: string;
    title: string;
    type: KnowledgeContentType;
    averageRating: number;
    reflectionCount: number;
    category: string;
  }>;
  recentReflections: Array<{
    id: string;
    createdAt: string;
    modelTitle: string;
    modelType: KnowledgeContentType;
    effectivenessRating: number;
    situationText: string;
    roadmapStepId: string;
    learningText?: string;
  }>;
  lastUpdated: string;
}
```

**Loading States Interface:**

```typescript
interface ProgressLoadingState {
  metrics: boolean;
  topModels: boolean;
  recentReflections: boolean;
  error: string | null;
}
```

### Streak Calculation Logic

**Streak Algorithm:**

```typescript
function calculateStreak(reflectionDates: Date[]): number {
  if (reflectionDates.length === 0) return 0;

  // Sort dates descending (most recent first)
  const sortedDates = reflectionDates.sort((a, b) => b.getTime() - a.getTime());

  let streak = 0;
  let currentDate = new Date();
  currentDate.setHours(0, 0, 0, 0); // Start of today

  for (const reflectionDate of sortedDates) {
    const reflectionDay = new Date(reflectionDate);
    reflectionDay.setHours(0, 0, 0, 0);

    const daysDiff = Math.floor(
      (currentDate.getTime() - reflectionDay.getTime()) / (1000 * 60 * 60 * 24)
    );

    if (daysDiff === streak) {
      streak++;
      currentDate.setTime(currentDate.getTime() - 1000 * 60 * 60 * 24); // Move back one day
    } else if (daysDiff > streak) {
      // Gap found, streak ends
      break;
    }
  }

  return streak;
}
```

### UI Design Guidelines

**Visual Hierarchy:**

- Dashboard title: text-3xl font-bold
- Section headers: text-xl font-semibold
- Card titles: text-lg font-medium
- Metrics: text-2xl font-bold with accent colors
- Body text: text-base with proper line-height

**Color Strategy:**

- Streak flame: Gradient based on streak level
- Progress bars: Primary color with success variants
- Star ratings: Yellow/gold for filled, gray for empty
- Cards: Consistent with existing card styling

**Animation Guidelines:**

- Gentle transitions for data updates (300ms ease)
- Skeleton loading with shimmer effect
- Micro-interactions for user feedback
- Celebration animations for milestones

### Performance Strategy

**Database Optimization:**

- Index on application_logs.created_at for streak queries
- Index on effectiveness_rating for top models queries
- Composite index on (user_id, created_at) for recent reflections
- Use database functions for complex aggregations

**Frontend Optimization:**

- Server-side rendering for initial data load
- Client-side caching with SWR for updates
- Memoization of expensive calculations
- Lazy loading for non-critical sections
- Image optimization for icons and illustrations

**Caching Strategy:**

- Redis cache for expensive streak calculations
- Browser cache for static assets
- SWR cache for frequently accessed data
- Cache invalidation on reflection completion

### Error Handling Strategy

**Network Errors:**

- Graceful fallback to cached data
- Retry mechanism with exponential backoff
- User-friendly error messages
- Manual refresh option

**Data Inconsistencies:**

- Validation of calculated metrics
- Fallback to safe defaults
- Error logging for debugging
- Automatic error recovery where possible

### Accessibility Requirements

**WCAG AA Compliance:**

- Color contrast ratios ≥ 4.5:1
- Keyboard navigation for all interactive elements
- Screen reader support with proper ARIA labels
- Focus indicators clearly visible
- Text scaling up to 200% without horizontal scrolling

**Screen Reader Support:**

- Descriptive alt text for flame icons and charts
- ARIA live regions for dynamic updates
- Proper heading hierarchy
- Meaningful link text
- Form labels and descriptions

### File Locations

**To be created:**

- `/app/(app)/progress/page.tsx` - Main progress dashboard page
- `/app/(app)/progress/loading.tsx` - Dashboard loading state
- `/app/(app)/progress/error.tsx` - Error boundary with retry
- `/app/(app)/progress/__tests__/progress.test.tsx` - Page integration tests
- `/components/features/progress/ProgressDashboard.tsx` - Main dashboard component
- `/components/features/progress/StreakCard.tsx` - Streak display with flame
- `/components/features/progress/ReflectionStatsCard.tsx` - Total reflection stats
- `/components/features/progress/RoadmapProgressCard.tsx` - Current roadmap progress
- `/components/features/progress/EffectiveModelsSection.tsx` - Top effective models
- `/components/features/progress/RecentReflectionsSection.tsx` - Recent reflections list
- `/components/features/progress/ProgressDashboardSkeleton.tsx` - Loading skeleton
- `/components/features/progress/EmptyProgressState.tsx` - Empty state component
- `/components/features/progress/__tests__/progress-dashboard.test.tsx` - Component tests
- `/lib/queries/progress-queries.ts` - Progress metrics database queries
- `/lib/utils/date-utils.ts` - Date and timezone utilities

**To be modified:**

- Navigation components to add "Progress" menu item
- `/lib/stores/roadmap-store.ts` if global progress state needed

### Success Metrics

Following Epic 2 success criteria:

- Increased user engagement (daily active users)
- Higher completion rates for learning loops
- Improved user retention (7-day and 30-day)
- Reduced time between reflections
- Higher effectiveness ratings as users see progress

**Specific Progress Dashboard Metrics:**

- Dashboard page views and session duration
- Streak achievement celebrations
- Click-through rates from progress to roadmap/reflections
- User satisfaction with motivation features
- Reduction in learning abandonment rates

### Risk Mitigation

**Performance Risks:**

- Heavy database queries for metrics calculation
- Large datasets impacting dashboard load times
- Mobile performance on older devices
- Real-time updates causing excessive requests

**User Experience Risks:**

- Overwhelming users with too much data
- Demotivating users with low metrics
- Confusing navigation or unclear metrics
- Empty states not being encouraging enough

**Technical Risks:**

- Timezone handling for global users
- Data consistency across multiple tables
- Cache invalidation complexity
- Integration with existing navigation system

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-08-04 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
