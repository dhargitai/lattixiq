# Story 0.3: Set Up Supabase Project and Authentication

## Status
Draft

## Story
**As a** user  
**I want** secure authentication  
**so that** my data is protected and personalized

## Acceptance Criteria
1. Supabase project created
2. Environment variables configured
3. Supabase client initialized
4. Auth middleware implemented
5. Email/Magic Link authentication working
6. Connection verified via Supabase MCP

## Tasks / Subtasks
- [ ] Task 1: Create Supabase project (AC: 1)
  - [ ] Create new project at supabase.com
  - [ ] Configure project settings for production use
  - [ ] Note down project URL and anon key
- [ ] Task 2: Configure environment variables (AC: 2)
  - [ ] Create `.env.local` file (ensure it's in .gitignore)
  - [ ] Add `NEXT_PUBLIC_SUPABASE_URL` from Supabase project
  - [ ] Add `NEXT_PUBLIC_SUPABASE_ANON_KEY` from Supabase project
  - [ ] Verify environment variables are properly loaded
- [ ] Task 3: Install and initialize Supabase client (AC: 3)
  - [ ] Install required packages: `npm install @supabase/supabase-js @supabase/ssr`
  - [ ] Create `/lib/supabase/client.ts` for client-side Supabase instance
  - [ ] Create `/lib/supabase/server.ts` for server-side Supabase instance
  - [ ] Follow Supabase SSR setup pattern for Next.js App Router
- [ ] Task 4: Implement authentication middleware (AC: 4)
  - [ ] Create `/middleware.ts` at project root
  - [ ] Implement session checking logic for protected routes [Source: architecture/8-frontend-architecture.md#Protected Route Pattern]
  - [ ] Configure matcher to protect `/(app)` routes while allowing `/(auth)` routes
  - [ ] Handle session refresh and cookie management
- [ ] Task 5: Create login page with Magic Link (AC: 5)
  - [ ] Create `/app/(auth)/login/page.tsx` following route organization [Source: architecture/8-frontend-architecture.md#Route Organization]
  - [ ] Implement magic link form using Supabase Auth
  - [ ] Add proper error handling and loading states
  - [ ] Style using Tailwind and shadcn/ui components from Story 0.2
- [ ] Task 6: Verify Supabase connection (AC: 6)
  - [ ] Test magic link authentication flow end-to-end
  - [ ] Verify session persistence and refresh
  - [ ] Confirm middleware properly protects routes
  - [ ] Use Supabase MCP tools if available to verify connection

## Dev Notes

### Technology Requirements
- **Supabase**: Version ~15.x (PostgreSQL database with built-in auth)
- **Supabase Auth**: Version ~2.0.0 (handles social & OTP auth)
- **@supabase/supabase-js**: Client library for Supabase
- **@supabase/ssr**: Server-side rendering support for Next.js
[Source: architecture/2-tech-stack.md]

### Authentication Architecture
- **Client-Side Auth**: Handled by Supabase Auth library (no custom /login or /register API endpoints)
- **Server-Side Validation**: All API routes validate Supabase JWT tokens
- **Middleware Protection**: Single middleware.ts file handles route protection
- **Session Management**: Supabase handles session refresh automatically
[Source: architecture/4-api-specification.md#Authentication]

### Route Protection Pattern

`/middleware.ts` structure

- Check for valid Supabase session
- Redirect unauthenticated users from protected routes to /login
- Allow access to public routes (/(auth)/*)
- Handle session cookie refresh

Matcher configuration excludes:

- _next/static (static files)
- _next/image (image optimization)
- favicon.ico
- api routes
- auth routes
[Source: architecture/8-frontend-architecture.md#Protected Route Pattern]

### File Structure
Key files to create:
- `/lib/supabase/client.ts` - Client-side Supabase instance
- `/lib/supabase/server.ts` - Server-side Supabase instance
- `/middleware.ts` - Route protection middleware
- `/app/(auth)/login/page.tsx` - Login page
- `/.env.local` - Environment variables (never commit)
[Source: architecture/10-unified-project-structure.md]

### API Route Authentication Pattern
All API routes must follow this pattern:
```tsx
const supabase = createRouteHandlerClient({ cookies });
const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  return new NextResponse('Unauthorized', { status: 401 });
}
```
[Source: architecture/9-backend-architecture.md#API Route Template]

### Previous Story Context
- Story 0.1: Next.js project with TypeScript configured
- Story 0.2: Tailwind CSS and shadcn/ui components available

### Security Considerations
- Never commit `.env.local` file
- Use Row-Level Security (RLS) in Supabase for data protection
- All sensitive operations must verify user session
- Follow security best practices from coding standards
[Source: architecture/12-coding-standards.md]

### Testing
- Test one-time password (OTP) email delivery
- Verify session persistence across page reloads
- Test middleware route protection (both allowing and blocking)
- Ensure proper error handling for auth failures
- Follow TDD approach with happy/unhappy paths
[Source: architecture/11-testing-strategy.md#Happy and Unhappy Path Coverage]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-30 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_