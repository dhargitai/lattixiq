# Story 3.7: Implement Testimonial Collection

## Status

**Status:** Ready for Review

## Story

**As a** product team  
**I want** to collect user testimonials via Senja.io  
**So that** we can showcase success stories and track user satisfaction

## Acceptance Criteria

1. Prompt appears after first roadmap completion
2. Simple form with guided questions via Senja.io widget
3. Optional - user can skip/dismiss
4. Testimonial state tracked in database
5. Thank you message after submission
6. Only asked once per milestone
7. Senja.io widget properly embedded and styled
8. Testimonial URL optionally stored if provided by Senja

## Tasks / Subtasks

- [x] **Task 1: Add testimonial URL field to users table** (AC: 4, 8)
  - [x] Create migration to add `testimonial_url` field to users table (nullable text)
  - [x] Update TypeScript types to include the new field
  - [x] Deploy migration to development environment
        [Source: architecture/7-database-schema.md - users table already has testimonial_state field]

- [x] **Task 2: Create TestimonialPrompt component** (AC: 1, 2, 3, 7)
  - [x] Create `/components/features/toolkit/TestimonialPrompt.tsx`
  - [x] Implement card wrapper with conditional rendering based on testimonial_state
  - [x] Add dismissible UI with close button
  - [x] Style card to match "Serene Minimalist" aesthetic using shadcn/ui Card component
  - [x] Add content variants for different trigger states
        [Source: architecture/10-unified-project-structure.md - components/features location]

- [x] **Task 3: Integrate Senja.io widget** (AC: 2, 7)
  - [x] Add Senja.io embed script to component
  - [x] Configure widget with project-specific settings
  - [x] Style widget container to fit within the card design
  - [x] Ensure widget is responsive on mobile/tablet/desktop
  - [x] Handle widget loading states gracefully
        [Source: frontend-spec.md - Embedded Senja Testimonial Collector Widget]

- [x] **Task 4: Implement display logic for testimonial prompt** (AC: 1, 6)
  - [x] Add logic to check user's testimonial_state in Toolkit page
  - [x] Check if user has completed first roadmap (milestone 1)
  - [x] Check if user has high effectiveness ratings (milestone 2)
  - [x] Position testimonial card at top of Toolkit screen above active roadmap
  - [x] Only show if testimonial_state is 'not_asked' or 'asked_first' (for second milestone)
        [Source: architecture/3-data-models.md - testimonial_state enum values]

- [x] **Task 5: Create API endpoint for updating testimonial state** (AC: 3, 4, 5)
  - [x] Create `/app/api/users/testimonial/route.ts`
  - [x] Implement PATCH endpoint to update testimonial_state
  - [x] Add optional testimonial_url parameter
  - [x] Validate state transitions (not_asked → asked_first → dismissed_first/submitted)
  - [x] Return updated user object with new state
        [Source: architecture/4-api-specification.md - PATCH /me endpoint pattern]

- [x] **Task 6: Wire up client-side testimonial state management** (AC: 3, 5, 6)
  - [x] Add testimonial state update functions to user store if needed
  - [x] Handle dismiss action - update state to 'dismissed_first' or 'dismissed_second'
  - [x] Handle submission detection (if possible via Senja callback)
  - [x] Update state to 'submitted' on successful submission
  - [x] Show thank you message after submission
  - [x] Persist state changes to database via API

- [x] **Task 7: Add milestone detection logic** (AC: 1, 6)
  - [x] Create utility function to check if user completed first roadmap
  - [x] Create utility function to check sustained success (3 roadmaps in a row with high ratings)
  - [x] Use these in Toolkit page to determine which testimonial variant to show
  - [x] Ensure testimonial only requested once per milestone type

- [x] **Task 8: Write unit tests**
  - [x] Test testimonial state transitions
  - [x] Test milestone detection logic
  - [x] Test component rendering with different states
  - [x] Test API endpoint validation and responses
        [Source: architecture/11-testing-strategy.md - Vitest for unit tests]

- [x] **Task 9: Write integration tests**
  - [x] Test full testimonial flow from trigger to submission
  - [x] Test dismiss flow and state persistence
  - [x] Test that testimonial doesn't reappear after dismissal
  - [x] Test milestone-based triggering
        [Source: architecture/11-testing-strategy.md - Integration test patterns]

## Dev Notes

### Previous Story Insights

No previous story in Epic 3 has been completed yet (3.1, 3.2, 3.3 are postponed or incomplete).

### Data Models

- **User table testimonial tracking**:
  - `testimonial_state` field already exists with enum values: 'not_asked', 'asked_first', 'dismissed_first', 'submitted', 'asked_second', 'dismissed_second'
  - Need to add `testimonial_url` field (text, nullable) to store Senja testimonial URL if provided
    [Source: architecture/3-data-models.md#1-user]
    [Source: architecture/7-database-schema.md - testimonial_state enum]

### API Specifications

- **Update user testimonial state**: Follow pattern of PATCH /me endpoint
  - Request Body: `{ "testimonialState"?: TestimonialState, "testimonialUrl"?: string }`
  - Response: Updated User object
    [Source: architecture/4-api-specification.md - PATCH /me pattern]

### Component Specifications

- **TestimonialPrompt component location**: `/components/features/toolkit/TestimonialPrompt.tsx`
- **Styling**: Use shadcn/ui Card component as base, maintain "Serene Minimalist" aesthetic
- **Placement**: Top of My Toolkit screen, above active roadmap card
- **Content variants**:
  - First Win: "Congratulations on finishing your first roadmap! That's a huge achievement. If you have a moment, we'd love to hear about your experience."
  - Sustained Success: "Wow, you've completed several roadmaps with great results! We're so glad you're finding this valuable. If you're willing, we'd love for you to share your story."
    [Source: frontend-spec.md - Flow: Collecting User Testimonials]
    [Source: prototypes/my-toolkit.html - testimonial card structure]

### Frontend Alignment

- Senja.io widget should be embedded within the testimonial card
- Widget container should be responsive and styled to fit the card design
- Card should be dismissible with a close button
- Card appears conditionally based on testimonial_state and milestones
  [Source: frontend-spec.md - Embedded Senja Testimonial Collector Widget]

### File Locations

- Component: `/components/features/toolkit/TestimonialPrompt.tsx`
- API Route: `/app/api/users/testimonial/route.ts`
- Toolkit Page Integration: `/app/(app)/toolkit/page.tsx`
  [Source: architecture/10-unified-project-structure.md]

### Testing Requirements

- **Unit tests**: Use Vitest for component and utility function testing
- **Integration tests**: Test full testimonial flow including API calls
- **Test files location**:
  - Unit: `/tests/unit/components/TestimonialPrompt.test.tsx`
  - Integration: `/tests/integration/testimonial-flow.test.ts`
    [Source: architecture/11-testing-strategy.md]

### Technical Constraints

- Must use Senja.io for testimonial collection (external service)
- Testimonial state must follow defined enum transitions
- Component must be responsive across all breakpoints
- Must maintain data privacy - only track state, not testimonial content in our DB

### Testing

**Testing Standards from Architecture:**

- Test file location: `/tests/unit/` for unit tests, `/tests/integration/` for integration tests
- Use Vitest for unit and integration testing
- Follow TDD approach where possible
- Mock external dependencies (Senja.io widget) in tests
- Test both happy and unhappy paths
- Ensure 80% code coverage minimum
  [Source: architecture/11-testing-strategy.md]

## Change Log

| Date       | Version | Description           | Author             |
| ---------- | ------- | --------------------- | ------------------ |
| 2025-01-06 | 1.0     | Initial draft created | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.1

### Debug Log References

- No critical issues encountered during implementation
- Fixed TypeScript errors in test files by adding missing `testimonial_url` field
- Fixed linting issues with proper TypeScript imports and parameter naming

### Completion Notes List

- Successfully added testimonial_url field to users table via migration
- Created TestimonialPrompt component with Senja.io widget integration
- Implemented milestone detection for first roadmap and sustained success triggers
- Created API endpoint with proper state transition validation
- Added client-side state management with TestimonialPromptWrapper
- Integrated testimonial prompt display in Toolkit page
- Comprehensive test coverage with unit and integration tests
- All tests passing, linting successful

### File List

**New Files Created:**

- `/supabase/migrations/20250808_add_testimonial_url_to_users.sql` - Migration for testimonial_url field
- `/components/features/toolkit/TestimonialPrompt.tsx` - Main testimonial prompt component
- `/components/features/toolkit/SenjaWidget.tsx` - Senja.io widget integration component
- `/components/features/toolkit/TestimonialPromptWrapper.tsx` - Client-side state management wrapper
- `/app/api/users/testimonial/route.ts` - API endpoint for updating testimonial state
- `/lib/utils/testimonial-milestones.ts` - Milestone detection utility functions
- `/tests/unit/components/TestimonialPrompt.test.tsx` - Component unit tests
- `/tests/unit/utils/testimonial-milestones.test.ts` - Milestone logic unit tests
- `/tests/unit/api/testimonial.test.ts` - API endpoint unit tests
- `/tests/integration/testimonial-flow.test.ts` - Integration tests for full flow

**Modified Files:**

- `/app/(app)/toolkit/page.tsx` - Added testimonial prompt display logic
- `/lib/supabase/database.types.ts` - Updated with testimonial_url field
- `/tests/unit/settings/settings-page.test.tsx` - Fixed test data to include testimonial_url
- `/.env.example` - Added Senja.io configuration variables

## QA Results

_To be populated by QA agent_
