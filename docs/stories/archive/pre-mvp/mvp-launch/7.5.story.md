# Story 7.5: Remove Zustand Persistence

## Status

Done

## Story

**As a** developer,
**I want** Zustand to only manage transient UI state,
**so that** we avoid client-side caching issues

## Acceptance Criteria

1. [ ] `persist` middleware removed from `roadmap-store.ts`
2. [ ] Store only contains transient UI state
3. [ ] Data always fetched fresh from database
4. [ ] No localStorage keys created by Zustand
5. [ ] Application performance remains unchanged or improves

## Tasks / Subtasks

- [ ] Task 1: Remove Zustand persistence middleware from roadmap-store.ts (AC: 1, 4)
  - [ ] Remove persist import from zustand/middleware
  - [ ] Remove persist wrapper from the store creation
  - [ ] Remove partialize configuration
  - [ ] Remove name: "roadmap-storage" configuration
  - [ ] Verify no localStorage keys are created (check DevTools > Application > Local Storage)

- [ ] Task 2: Refactor cache management to use in-memory storage only (AC: 2, 3)
  - [ ] Keep cacheMetadata state but ensure it's not persisted
  - [ ] Maintain isCacheValid and invalidateCache functions for in-memory cache
  - [ ] Keep DEFAULT_CACHE_TTL for memory cache expiration
  - [ ] Test that cache invalidates properly on logout

- [ ] Task 3: Ensure data fetching always uses fresh data on mount (AC: 3)
  - [ ] Verify fetchActiveRoadmap always queries database on initial mount
  - [ ] Remove any localStorage checks in fetchActiveRoadmap
  - [ ] Test cross-device sync by logging in on different browsers
  - [ ] Ensure activeRoadmap is null on component mount before fetching

- [ ] Task 4: Update tests for non-persisted state (AC: 5)
  - [ ] Update tests/unit tests that mock localStorage for roadmap-store
  - [ ] Remove localStorage mocks from roadmap-store related tests
  - [ ] Verify tests pass with new in-memory only state
  - [ ] Add test to verify no localStorage keys are created

- [ ] Task 5: Performance validation (AC: 5)
  - [ ] Test app load time before and after changes
  - [ ] Verify no performance degradation in roadmap operations
  - [ ] Check memory usage remains reasonable
  - [ ] Test with multiple roadmap switches

## Dev Notes

### Previous Story Insights

- Stories 7.1-7.4 are handling database migration and other localStorage removal
- This story focuses specifically on removing Zustand persistence layer
- After this story, all state should be either fetched from database or transient UI state

### Technical Context

#### Current Zustand Implementation

The roadmap-store.ts currently uses persist middleware from Zustand [Source: lib/stores/roadmap-store.ts#L46-L321]. The persist configuration:

- Stores: activeRoadmap, currentStepIndex, currentStep, knowledgeContent, cacheMetadata
- Storage key: "roadmap-storage"
- Uses partialize to select which state to persist

#### State Management Strategy

After removal of persistence:

- **Transient state**: currentStepIndex, isLoading, error, currentStep, knowledgeContent
- **Cached state (in-memory only)**: activeRoadmap with TTL-based cache invalidation
- **Database-sourced**: All roadmap data fetched fresh on mount or cache expiry

#### File Locations

- Main file to modify: `/lib/stores/roadmap-store.ts` [Source: architecture/10-unified-project-structure.md#L32]
- Test files to update: Tests that reference roadmap-store

#### Architecture Alignment

Per the coding standards, we follow functional programming principles [Source: architecture/12-coding-standards.md#L9]:

- Keep functions pure where possible
- Avoid side effects (localStorage is a side effect)
- State should be predictable and deterministic

### Testing Requirements

From testing strategy [Source: architecture/11-testing-strategy.md]:

- **Integration Tests**: Test that store correctly fetches from database without persistence
- **Unit Tests**: Verify store state management without localStorage
- **E2E Tests**: Verify cross-device sync works (data from DB, not localStorage)

Test patterns to follow:

```tsx
describe("Roadmap Store without persistence", () => {
  it("should not create localStorage keys", () => {
    // Verify no keys in localStorage after store operations
  });

  it("should fetch fresh data on mount", () => {
    // Verify database query on initial mount
  });

  it("should maintain in-memory cache with TTL", () => {
    // Test cache validity and expiration
  });
});
```

### Security Considerations

Per security standards [Source: architecture/12-coding-standards.md#L271]:

- Never store sensitive data in localStorage (removing persistence ensures this)
- All user data should come from secure, authenticated database queries

## Change Log

| Date       | Version | Description            | Author           |
| ---------- | ------- | ---------------------- | ---------------- |
| 2025-01-11 | 1.0     | Initial story creation | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results
