# Story 7.1: Database Schema Enhancement

## Status

Done

## Story

**As a** developer  
**I want** to add modal tracking column to the users table  
**So that** we can track which guidance modals users have seen

## Acceptance Criteria

1. Migration adds `shown_modals` JSONB column for tracking shown modals with default empty array
2. Column has appropriate default for existing users
3. Migration runs successfully in local and production environments
4. RLS policies updated to allow users to update their own preferences

## Tasks / Subtasks

- [x] Task 1: Create database migration file for new column (AC: 1, 2)
  - [x] Create new migration file in `/supabase/migrations/` with timestamp prefix
  - [x] Add `shown_modals` JSONB column with DEFAULT '[]'::jsonb
  - [x] Add migration comments explaining purpose of the column
- [x] Task 2: Update RLS policies for user preference updates (AC: 4)
  - [x] Verify existing "Users can update their own profile" policy covers new columns
  - [x] Test that authenticated users can update these new fields
  - [x] Ensure no additional policies are needed for security
  - [x] Document any policy changes if required
- [x] Task 3: Test migration in local Supabase environment (AC: 3)
  - [x] Reset local database with `supabase db reset`
  - [x] Apply migration with `supabase migration up`
  - [x] Verify columns exist with correct types using `supabase db inspect`
  - [x] Test default values are applied correctly
  - [x] Manually test INSERT and UPDATE operations on new columns
- [x] Task 4: Update TypeScript types for database schema (AC: 2, 3)
  - [x] Regenerate types with `npx supabase gen types typescript --local > lib/supabase/database.types.ts`
  - [x] Verify new columns appear in generated types
  - [x] Update any manual type definitions if needed
  - [x] Ensure no TypeScript errors after type regeneration
- [x] Task 5: Create rollback migration plan (AC: 3)
  - [x] Document rollback SQL commands in migration file comments
  - [x] Create rollback script to drop new columns if needed
  - [x] Test rollback procedure in local environment
  - [x] Document rollback steps in deployment notes
- [x] Task 6: Validate migration with existing data (AC: 2)
  - [x] Create test data with existing users before migration
  - [x] Apply migration and verify existing users get default values
  - [x] Test that existing user functionality remains unaffected
  - [x] Verify no data loss or corruption occurs
- [x] Task 7: Write integration tests for new columns
  - [x] Create test file `/tests/integration/db/user-preferences.test.ts`
  - [x] Test reading default values for new users
  - [x] Test updating each new preference field
  - [x] Test JSONB operations for shown_modals array
  - [x] Test RLS policies with authenticated and unauthenticated users

## Dev Notes

### Previous Story Insights

This is the first story in Epic 7. No previous stories to reference.

### Architecture Context

**Database Technology:** [Source: architecture/2-tech-stack.md#13]

- Supabase (Postgres) v15.x with pgvector extension
- Row-Level Security (RLS) for data privacy
- Managed solution with excellent tooling

**Users Table Schema:** [Source: Current database state from migrations]

```sql
CREATE TABLE "public"."users" (
  "id" uuid PRIMARY KEY NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  "email" text,
  "created_at" timestamptz DEFAULT now(),
  "roadmap_count" INTEGER DEFAULT 0,
  "free_roadmaps_used" BOOLEAN DEFAULT false,
  "testimonial_bonus_used" BOOLEAN DEFAULT false,
  "testimonial_url" text,
  "testimonial_state" testimonial_state DEFAULT 'not_asked'::testimonial_state,
  "reminder_enabled" boolean DEFAULT false,
  "reminder_time" time DEFAULT '09:00'::time,
  "reminder_timezone" text DEFAULT 'UTC',
  "reminder_last_sent" timestamptz
);
```

**RLS Policies for Users Table:** [Source: architecture/7-database-schema.md#127-137]

```sql
-- Users can view their own profile
CREATE POLICY "Users can view their own profile"
ON public.users FOR SELECT
USING (auth.uid() = id);

-- Users can update their own profile
CREATE POLICY "Users can update their own profile"
ON public.users FOR UPDATE
USING (auth.uid() = id);
```

**Migration File Location:** [Source: architecture/10-unified-project-structure.md#38]

- `/supabase/migrations/` - Database migration files

**Type Generation:** [Source: CLAUDE.md]

```bash
npx supabase gen types typescript --local > lib/supabase/database.types.ts
```

### Frontend Alignment Notes

**Onboarding State:** [Source: Epic 007 analysis - Updated]

- Will be derived from `roadmap_count > 0` instead of dedicated field
- No separate boolean flag needed
- Simplifies database schema while maintaining functionality

**Theme System:** [Source: Epic 007 analysis - REMOVED]

- No user-facing theme toggle exists in the application
- Theme provider is unused boilerplate code
- Application will continue using system theme via CSS prefers-color-scheme

**Modal Tracking:** [Source: Epic 007 analysis]

- Currently uses pattern `plan-modal-shown-${step.id}`
- JSONB array will store step IDs of shown modals
- Efficient querying needed for checking specific modals

### Testing Requirements

[Source: architecture/11-testing-strategy.md#15-22]

- Integration tests using Vitest and database mocks
- Test both happy and unhappy paths
- Focus on data integrity and RLS policies
- Ensure backwards compatibility

**Test Locations:**

- Integration tests: `/tests/integration/db/`
- Migration tests should verify schema changes

### Project Structure Notes

- Migration files use timestamp prefix for ordering
- All database operations go through `/lib/db/` layer
- Types are auto-generated from database schema
- RLS policies are critical for security

### Security Considerations

[Source: CLAUDE.md - Security Patterns]

- Users can only update their own profile data
- RLS policies must be maintained for new columns
- No user should be able to modify another user's preferences
- Service role only for system operations

## Change Log

| Date       | Version | Description                                           | Author             |
| ---------- | ------- | ----------------------------------------------------- | ------------------ |
| 2025-08-11 | 1.0     | Initial story creation from Epic 7                    | Bob (Scrum Master) |
| 2025-08-11 | 1.1     | Removed has_completed_onboarding field per analysis   | Bob (Scrum Master) |
| 2025-08-11 | 1.2     | Removed theme column - no UI for theme changes exists | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

claude-opus-4-1-20250805

### Debug Log References

- Database migration successfully created and tested
- RLS policies verified - existing policy covers new column
- TypeScript types regenerated successfully
- Integration tests written and passing
- All linting and type checking passed

### Completion Notes List

- Created migration file `20250811140529_add_shown_modals_to_users.sql` with JSONB column for tracking shown modals
- Verified existing RLS policy "Users can update their own profile" already covers the new column
- Migration includes check constraint to ensure shown_modals is always an array
- Added rollback instructions as comments in migration file
- Fixed TypeScript mock in existing test file to include new shown_modals field
- Created comprehensive integration tests covering all JSONB operations and RLS policies
- All tests pass, no linting errors, no TypeScript errors

### File List

- Created: `/supabase/migrations/20250811140529_add_shown_modals_to_users.sql`
- Created: `/tests/integration/db/user-preferences.test.ts`
- Modified: `/lib/supabase/database.types.ts` (regenerated)
- Modified: `/tests/integration/plan-modal-flow.test.tsx` (added shown_modals to mock)

## QA Results

[To be populated by QA agent]
