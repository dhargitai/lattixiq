# Story 7.6: Update Logout Flow

## Status

Done

## Story

**As a** user,
**I want** logout to properly clear my session,
**so that** my data is secure when I sign out

## Acceptance Criteria

1. [ ] `LogoutButton.tsx` no longer calls localStorage.clear()
2. [ ] sessionStorage.clear() removed
3. [ ] Only Supabase signOut and cache clearing remain
4. [ ] Logout properly clears all user state
5. [ ] No residual data remains after logout

## Tasks / Subtasks

- [ ] Task 1: Remove localStorage and sessionStorage clearing from LogoutButton (AC: 1, 2)
  - [ ] Remove localStorage.clear() call from handleLogout function
  - [ ] Remove sessionStorage.clear() call from handleLogout function
  - [ ] Keep Supabase signOut() call
  - [ ] Keep router.push("/login") navigation

- [ ] Task 2: Ensure Zustand stores are properly reset on logout (AC: 3, 4)
  - [ ] Call resetState() on roadmap-store during logout
  - [ ] Verify any other Zustand stores are also reset
  - [ ] Ensure in-memory cache is cleared (invalidateCache)
  - [ ] Test that all UI state resets to initial values

- [ ] Task 3: Verify complete session cleanup (AC: 4, 5)
  - [ ] Check that Supabase auth session is cleared
  - [ ] Verify no user data remains in Zustand stores
  - [ ] Confirm no cookies or tokens remain
  - [ ] Test logging back in shows fresh state

- [ ] Task 4: Update logout tests (AC: 5)
  - [ ] Update tests/unit/settings/logout-button.test.tsx
  - [ ] Remove localStorage.clear() mock expectations
  - [ ] Remove sessionStorage.clear() mock expectations
  - [ ] Add tests for Zustand store reset
  - [ ] Verify E2E logout test still passes

- [ ] Task 5: Cross-device verification (AC: 5)
  - [ ] Test logout on one device doesn't affect another session
  - [ ] Verify no client-side data leaks between sessions
  - [ ] Test rapid login/logout cycles for state consistency
  - [ ] Ensure no zombie state from previous sessions

## Dev Notes

### Previous Story Insights

- Story 7.5 removes Zustand persistence, making this cleanup simpler
- Stories 7.1-7.4 handle database migration for user preferences
- This story ensures logout flow aligns with new state management approach

### Technical Context

#### Current Logout Implementation

The LogoutButton component currently [Source: components/settings/LogoutButton.tsx]:

- Calls localStorage.clear()
- Calls sessionStorage.clear()
- Signs out from Supabase
- Navigates to login page

#### Updated Logout Flow

After this story, logout should:

1. Reset all Zustand stores to initial state
2. Clear Supabase auth session
3. Navigate to login page
4. NOT touch localStorage or sessionStorage

#### File Locations

- Main component: `/components/settings/LogoutButton.tsx` [Source: architecture/10-unified-project-structure.md#L29]
- Zustand stores: `/lib/stores/` directory
- Test file: `/tests/unit/settings/logout-button.test.tsx`

#### State Management After Logout

Per the architecture, all state should be cleared [Source: architecture/12-coding-standards.md#L9]:

- Zustand stores reset to initial state
- No persisted client-side data
- Fresh state on next login

### Security Considerations

From security standards [Source: architecture/12-coding-standards.md#L271-L282]:

- Ensure complete session cleanup to prevent data leaks
- No sensitive data should remain in browser after logout
- Auth tokens must be invalidated
- Next login should start with completely fresh state

Example secure logout pattern:

```tsx
const handleLogout = async () => {
  // Reset all client state
  useRoadmapStore.getState().resetState();

  // Clear auth session
  await supabase.auth.signOut();

  // Navigate to login
  router.push("/login");
};
```

### Testing Requirements

From testing strategy [Source: architecture/11-testing-strategy.md#L34-L61]:

**Unit Tests**:

```tsx
describe("LogoutButton", () => {
  it("should reset Zustand stores on logout", () => {
    // Mock store reset and verify it's called
  });

  it("should not call localStorage.clear()", () => {
    // Ensure localStorage is not touched
  });

  it("should sign out from Supabase", () => {
    // Verify auth.signOut() is called
  });
});
```

**Integration Tests**:

- Verify complete state cleanup
- Test navigation after logout
- Ensure no residual data

**E2E Tests**:

- Full logout flow from UI
- Verify return to login page
- Test that next login has fresh state

### Implementation Notes

The logout button should be simple and focused:

- No complex cleanup logic (state management handles itself)
- Clear user feedback during logout
- Handle errors gracefully (network issues during signOut)

## Change Log

| Date       | Version | Description            | Author           |
| ---------- | ------- | ---------------------- | ---------------- |
| 2025-01-11 | 1.0     | Initial story creation | Scrum Master Bob |

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results
