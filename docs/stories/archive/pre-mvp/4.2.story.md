# Story 4.2: Create Basic Premium Gates with Dialog CTA

## Status

Done

## Story

**As a** product owner  
**I want** premium features properly gated after first roadmap  
**So that** users are encouraged to subscribe

## Acceptance Criteria

1. First roadmap creation and completion always free
2. After first roadmap completion, "See what you'll get with Premium" button replaces "Create New Roadmap"
3. Button opens dialog with premium benefits from database
4. Dialog includes CTA to Stripe checkout for monthly subscription
5. /new-roadmap redirects to /toolkit if user has roadmaps but no subscription
6. Premium content editable in database without deployment

## Tasks / Subtasks

- [x] Create content_blocks table schema and migration (AC: 6)
  - [x] Design table structure with content_id, content, metadata fields
  - [x] Create migration file in `/supabase/migrations/`
  - [x] Run migration and verify table creation
  - [x] Update TypeScript types after migration

- [x] Seed initial premium benefits content (AC: 3, 6)
  - [x] Create seed script for content_blocks table
  - [x] Add 'premium-benefits-modal' content with markdown
  - [x] Verify content is retrievable from database

- [x] Create content blocks API endpoint (AC: 6)
  - [x] Implement GET `/app/api/content-blocks/[contentId]/route.ts`
  - [x] Add caching for performance
  - [x] Handle 404 for missing or unpublished content
  - [x] Add proper error handling

- [x] Create content utility functions (AC: 6)
  - [x] Implement `/lib/content/utils.ts` with getContentBlock()
  - [x] Add updateContentBlock() for admin purposes
  - [x] Add listContentBlocks() for content management
  - [x] Include proper TypeScript types

- [x] Update subscription checking utilities (AC: 1, 2, 5)
  - [x] Enhance `/lib/subscription/check-limits.ts` from Story 4.1
  - [x] Add checkCanCreateRoadmap(userId) function
  - [x] Add hasCompletedFreeRoadmap(userId) function
  - [x] Add getTestimonialBonus(userId) placeholder
  - [x] Integrate with existing hasActiveSubscription() from Story 4.1

- [x] Create PremiumBenefitsDialog component (AC: 3, 4)
  - [x] Create `/components/features/subscription/PremiumBenefitsDialog.tsx`
  - [x] Fetch content using content_id: 'premium-benefits-modal'
  - [x] Render markdown content with proper styling
  - [x] Add "Get Premium Access" button that calls Stripe checkout
  - [x] Use shadcn/ui Dialog component with custom styling
  - [x] Match "Serene Minimalist" aesthetic from prototypes

- [x] Update toolkit page UI (AC: 2, 3)
  - [x] Modify `/app/(app)/toolkit/page.tsx`
  - [x] Check if user has completed first roadmap and no subscription
  - [x] Replace "Create New Roadmap" with "See what you'll get with Premium" button
  - [x] Button opens PremiumBenefitsDialog when clicked
  - [x] Add success/failure message handling from checkout query params

- [x] Add route guards to new-roadmap page (AC: 5)
  - [x] Update `/app/(app)/new-roadmap/page.tsx`
  - [x] Check subscription limits before allowing access
  - [x] Redirect to `/toolkit?blocked=true` if not allowed
  - [x] Show appropriate message on toolkit page for blocked users

- [x] Update user profile schema for tracking (AC: 1, 2)
  - [x] Create migration to add roadmap tracking fields:
    - roadmap_count (integer, default 0)
    - free_roadmaps_used (boolean, default false)
    - testimonial_bonus_used (boolean, default false)
  - [x] Run migration and update TypeScript types

- [x] Write comprehensive tests (AC: 1-6)
  - [x] Unit tests for subscription limit checking functions
  - [x] Integration tests for content blocks API
  - [x] Component tests for PremiumBenefitsDialog
  - [x] E2E test for premium gating flow
  - [x] Test both happy and unhappy paths

## Dev Notes

### Previous Story Insights

From Story 4.1 completion:

- Stripe integration successfully implemented with checkout endpoints at `/app/api/checkout/route.ts` and `/app/api/checkout/callback/route.ts`
- Database already has Stripe subscription fields: stripe_customer_id, stripe_subscription_id, subscription_status, subscription_current_period_end
- Subscription checking utility exists at `/lib/subscription/check-limits.ts` with hasActiveSubscription() function
- Environment variables configured: STRIPE_PUBLISHABLE_KEY, STRIPE_MONTHLY_PRODUCT_ID
- Used text field for subscription_status for flexibility with values: 'free', 'active', 'canceled', 'past_due'

### Data Models

**Content Blocks Table** [Source: Epic 4 Story 4.2 Technical Tasks]:

```sql
content_blocks:
- id (uuid, primary key, default gen_random_uuid())
- content_id (text, unique, indexed) -- slug identifier
- content (text) -- markdown content
- metadata (jsonb, nullable) -- optional structured data
- created_at (timestamptz, default now())
- updated_at (timestamptz, default now())
- published (boolean, default true)
```

**User Table Extensions** [Source: Epic 4 Story 4.2 Technical Tasks]:

```sql
- roadmap_count (integer, default 0)
- free_roadmaps_used (boolean, default false)
- testimonial_bonus_used (boolean, default false)
```

### API Specifications

**Content Blocks Endpoint** [Source: Epic 4 Story 4.2 Technical Tasks]:

- GET `/api/content-blocks/[contentId]/route.ts`
- Returns content by content_id slug
- Cached for performance
- Returns 404 if content_id not found or not published
- Response format: `{ content: string, metadata?: object }`

### Component Specifications

**PremiumBenefitsDialog Component** [Source: prototypes/my-toolkit.html#69-149]:

- Uses shadcn/ui Dialog component as base
- Gradient background: `linear-gradient(135deg, #EBF4FF 0%, #E6F7FF 100%)`
- Border: `1px solid #BEE3F8`
- Border radius: 16px
- Close button in top-right corner
- Center-aligned content with generous padding
- "Get Premium Access" button styled as primary CTA

**Toolkit Page Updates** [Source: prototypes/my-toolkit.html]:

- Premium button should replace the "Create New Roadmap" button location
- Button styling should match existing primary button styles
- Success messages appear as toast notifications
- Page uses card-based layout with gradient backgrounds

### Frontend Alignment

Based on prototype review [Source: prototypes/my-toolkit.html]:

- Toolkit page has testimonial card section (lines 69-149) - will be implemented in Story 4.3
- Welcome message section (lines 151-162)
- Active roadmap card section (lines 165-200)
- Premium CTA should appear where "Create New Roadmap" would normally be
- Uses "Serene Minimalist" aesthetic with soft gradients and ample whitespace

### File Locations

Based on project structure [Source: architecture/10-unified-project-structure.md]:

- API Routes: `/app/api/content-blocks/[contentId]/route.ts`
- Components: `/components/features/subscription/PremiumBenefitsDialog.tsx`
- Utilities: `/lib/content/utils.ts`, `/lib/subscription/check-limits.ts`
- Database migrations: `/supabase/migrations/`
- Page components: `/app/(app)/toolkit/page.tsx`, `/app/(app)/new-roadmap/page.tsx`

### Testing Requirements

[Source: architecture/11-testing-strategy.md#38-60]:

- Integration tests location: `/tests/integration/api/content-blocks.test.ts`
- Component tests location: `/tests/unit/components/premium-dialog.test.tsx`
- Use Vitest for unit/integration tests
- Mock Supabase calls in tests
- Test naming: `should [expected behavior] when [condition]`
- Include both happy and unhappy paths:
  - Happy: User with no roadmap can create first free
  - Happy: Premium user can create multiple roadmaps
  - Unhappy: User with completed roadmap blocked without subscription
  - Unhappy: Invalid content_id returns 404

### Technical Constraints

- Follow functional programming style [Source: architecture/12-coding-standards.md#8-23]
- Use snake_case for database fields [Source: architecture/12-coding-standards.md#66-75]
- Validate all input with Zod schemas [Source: architecture/12-coding-standards.md#217-238]
- Never expose internal error details [Source: architecture/12-coding-standards.md#244-264]
- Use shadcn/ui components (v2.0.0) [Source: architecture/2-tech-stack.md#9]
- Tailwind CSS v4.0.0 for styling [Source: architecture/2-tech-stack.md#10]
- Cache API responses using lru-cache [Source: architecture/2-tech-stack.md#17]

### Security Considerations

- Content blocks table requires Row-Level Security [Source: architecture/7-database-schema.md#187-199]
- Only authenticated users can read content blocks
- No public write access to content blocks (admin only via service role)
- Validate content_id input to prevent injection [Source: architecture/12-coding-standards.md#217-238]
- Use parameterized queries for all database operations

## Testing

### Testing Standards

[Source: architecture/11-testing-strategy.md]:

- Test file locations:
  - `/tests/integration/api/content-blocks.test.ts` - API endpoint tests
  - `/tests/unit/subscription/check-limits.test.ts` - Subscription logic tests
  - `/tests/unit/components/premium-dialog.test.tsx` - Component tests
- Use Vitest for test runner
- Mock Supabase and Stripe calls
- Test against separate test database
- Follow TDD Red-Green-Refactor cycle
- Test naming convention: `should [expected behavior] when [condition]`

### Key Test Scenarios

1. Content blocks API returns correct content for valid content_id
2. Content blocks API returns 404 for invalid content_id
3. First roadmap creation allowed without subscription
4. Second roadmap creation blocked without subscription
5. Premium dialog renders markdown content correctly
6. Premium dialog CTA triggers Stripe checkout
7. Route guard redirects non-subscribers from /new-roadmap
8. Toolkit page shows correct button based on subscription status
9. Cache works correctly for content blocks API

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-08 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References

- Successfully created content_blocks table with RLS policies
- Implemented LRU cache for content API performance optimization
- Added react-markdown dependency for rendering premium benefits content
- Fixed TypeScript type issues in test files for new user fields

### Completion Notes List

1. Created content_blocks table with proper indexing and RLS policies
2. Seeded initial premium benefits content successfully
3. Implemented content blocks API with 15-minute LRU caching
4. Created comprehensive utility functions for content management
5. Enhanced subscription checking utilities with roadmap tracking
6. Built PremiumBenefitsDialog component with Stripe integration
7. Updated QuickActions component with conditional premium gating
8. Added route guards to prevent unauthorized roadmap creation
9. Extended user schema with roadmap tracking fields
10. Wrote unit, integration, and E2E tests for all components
11. Fixed all linting and type checking issues

### File List

**New Files Created:**

- `/supabase/migrations/20250810_add_content_blocks_table.sql`
- `/supabase/migrations/20250811_seed_premium_benefits_content.sql`
- `/supabase/migrations/20250812_add_roadmap_tracking_fields.sql`
- `/app/api/content-blocks/[contentId]/route.ts`
- `/lib/content/utils.ts`
- `/components/features/subscription/PremiumBenefitsDialog.tsx`
- `/tests/unit/subscription/check-limits.test.ts`
- `/tests/integration/api/content-blocks.test.ts`
- `/tests/unit/components/premium-dialog.test.tsx`
- `/tests/e2e/premium-gating.spec.ts`

**Modified Files:**

- `/lib/subscription/check-limits.ts` - Added getTestimonialBonus and enhanced getUserSubscriptionStatus
- `/components/features/toolkit/QuickActions.tsx` - Added premium dialog and subscription checking
- `/app/(app)/toolkit/page.tsx` - Passed additional props to QuickActions
- `/app/(app)/new-roadmap/page.tsx` - Added route guard for subscription checking
- `/lib/supabase/database.types.ts` - Regenerated with new fields
- `/tests/unit/settings/settings-page.test.tsx` - Updated mocks for new user fields

## QA Results

_To be populated after QA review_
