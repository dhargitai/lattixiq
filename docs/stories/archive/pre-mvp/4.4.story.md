# Story 4.4: Subscription Management in Settings

## Status

Ready for Review

## Story

**As a** premium user  
**I want** to manage my subscription  
**So that** I can view and update my premium access

## Acceptance Criteria

1. Settings page shows current subscription status
2. Active subscribers can click to access Stripe billing portal
3. Clear display of subscription period and renewal date
4. Billing portal allows users to update their subscription
5. Subscription status syncs with Stripe webhooks

## Tasks / Subtasks

- [x] Create billing section for settings page (AC: 1)
  - [x] Create `/app/(app)/settings/billing/page.tsx` following project structure
  - [x] Display subscription status from user_subscriptions table
  - [x] Show "Free" or "Premium" badge based on subscription_status
  - [x] Display current period end date if subscribed
  - [x] Include skeleton loading state while fetching data
  - [x] Follow "Serene Minimalist" design from BillingSection component

- [x] Implement Stripe billing portal API route (AC: 2, 4)
  - [x] Create `/app/api/billing-portal/route.ts`
  - [x] Verify user authentication and get user ID
  - [x] Retrieve stripe_customer_id from user_subscriptions table
  - [x] Create Stripe billing portal session using stripe.billingPortal.sessions.create()
  - [x] Set return_url to `/settings/billing`
  - [x] Handle errors (no customer ID, Stripe API errors)
  - [x] Return portal URL in response for redirect

- [x] Update BillingSection component (AC: 2, 3)
  - [x] Remove TODO comment and implement actual portal redirect
  - [x] Call `/api/billing-portal` endpoint when premium user clicks "Manage Subscription"
  - [x] Handle loading and error states during redirect
  - [x] Add subscription period display if active subscription
  - [x] Format dates using subscription_current_period_end
  - [x] Show simple "Manage Subscription" text for premium users

- [x] Create subscription status utilities (AC: 1, 3)
  - [x] Create `/lib/subscription/status.ts` with helper functions
  - [x] Implement getSubscriptionStatus(userId) to fetch from user_subscriptions
  - [x] Implement formatSubscriptionPeriod(date) for date formatting
  - [x] Implement isSubscriptionActive(status) checking active/trialing states
  - [x] Add getSubscriptionDetails(userId) combining all subscription info

- [x] Add real-time status updates from webhooks (AC: 5)
  - [x] Ensure webhook handler updates user_subscriptions table
  - [x] Add subscription status refresh after portal return
  - [x] Handle grace periods for past_due subscriptions
  - [x] Display appropriate status badge for subscription state

- [x] Add tests for subscription management
  - [x] Unit test for BillingSection component rendering states
  - [x] Unit test for subscription status utilities
  - [x] Integration test for billing portal API route
  - [x] Test portal session creation with mock Stripe client

## Dev Notes

### Previous Story Insights

From Story 4.3, the testimonial system was successfully implemented using the user_subscriptions table for subscription tracking. The BillingSection component already exists at `/components/settings/BillingSection.tsx` with basic structure and TODO for portal integration.

### Data Models

**user_subscriptions table** [Source: architecture/7-database-schema.md#Security Tables]:

```sql
CREATE TABLE user_subscriptions (
  user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  subscription_status TEXT DEFAULT 'free',
  stripe_customer_id TEXT,
  stripe_subscription_id TEXT,
  subscription_current_period_end TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

- Read-only for users, writable only by service role (webhooks)
- subscription_status values: 'free', 'active', 'trialing', 'past_due', 'canceled'

### API Specifications

**Stripe Billing Portal Session Creation** [Source: Context7 Stripe Node documentation]:

```typescript
// Create billing portal session for subscription management
const session = await stripe.billingPortal.sessions.create({
  customer: "cus_xxx",
  return_url: "https://yoursite.com/settings/billing",
});
// Redirect user to session.url where they can update their subscription
```

**Existing Route Structure** [Source: architecture/10-unified-project-structure.md]:

- API routes: `/app/api/[resource]/route.ts`
- Settings pages: `/app/(app)/settings/[feature]/page.tsx`

### Component Specifications

**BillingSection Component** (Already exists at `/components/settings/BillingSection.tsx`):

- Currently shows subscription status with Free/Premium badge
- Has placeholder for Stripe portal redirect (line 31-37)
- Premium users see "Manage Subscription" option to access billing portal
- Uses shadcn/ui Card component
- Follows Serene Minimalist design with hover effects

### File Locations

Based on project structure [Source: architecture/10-unified-project-structure.md]:

- New settings page: `/app/(app)/settings/billing/page.tsx`
- New API route: `/app/api/billing-portal/route.ts`
- New utilities: `/lib/subscription/status.ts`
- Existing component: `/components/settings/BillingSection.tsx`
- Existing utilities: `/lib/subscription/check-limits.ts`

### Testing Requirements

[Source: architecture/2-tech-stack.md#Testing]:

- Use Vitest for unit/integration tests
- Test files location: `/tests/unit/` and `/tests/integration/`
- Mock Stripe client for portal session tests
- Test all subscription states (free, active, expired, past_due)

### Technical Constraints

- Stripe SDK version: `latest` [Source: architecture/2-tech-stack.md]
- Next.js version: `~15.0.0` with App Router
- TypeScript with strict mode enabled
- Use server-side Supabase client for database queries
- Portal return URL must be absolute URL in production
- Stripe billing portal handles all subscription changes (upgrades, downgrades, cancellations)

### Security Considerations

- Always verify user authentication before creating portal session
- Never trust client-side subscription status
- Validate stripe_customer_id exists before portal creation
- Handle webhook signature verification for status updates
- User_subscriptions table is read-only for users

### Frontend Alignment

The existing BillingSection component already implements the design requirements from the prototypes. The component uses:

- Uppercase section headers with tracking
- Card-based layout with hover effects
- Premium badge with gradient background
- Simple "Manage Subscription" text for premium users
- One-click access to Stripe billing portal for subscription updates

## Testing

### Testing Standards

[Source: architecture/12-coding-standards.md#Testing]:

- Test file location: `/tests/unit/settings/` for component tests
- Test file location: `/tests/integration/api/` for API route tests
- Use Vitest with `describe`, `it`, `expect` pattern
- Mock external services (Stripe) in unit tests
- Use test doubles for Supabase queries in unit tests
- Integration tests should use actual Supabase test instance if available

### Specific Test Requirements

1. Test BillingSection renders correct status badge
2. Test portal redirect only works for premium users
3. Test error handling when no stripe_customer_id
4. Test date formatting for subscription period
5. Test loading states during API calls

## Change Log

| Date       | Version | Description                               | Author             |
| ---------- | ------- | ----------------------------------------- | ------------------ |
| 2025-01-08 | 1.0     | Initial story creation                    | Scrum Master (Bob) |
| 2025-01-08 | 1.1     | Simplified to focus on portal access only | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References

None - all tests pass and implementation is complete.

### Completion Notes List

- Created client-side billing page with real-time subscription status fetching
- Implemented Stripe billing portal API route with proper error handling
- Updated BillingSection component to display subscription period and handle portal redirects
- Created comprehensive subscription status utilities for reusable subscription logic
- Webhook handler already existed and properly updates user_subscriptions table
- Added comprehensive test coverage for all components and API routes
- Fixed all TypeScript and linting errors

### File List

- Created: `/app/(app)/settings/billing/page.tsx` - Client-side billing page
- Created: `/app/api/billing-portal/route.ts` - Stripe billing portal API endpoint
- Modified: `/components/settings/BillingSection.tsx` - Added subscription period display and portal redirect
- Created: `/lib/subscription/status.ts` - Subscription status utility functions
- Modified: `/components/settings/SettingsPageContent.tsx` - Added subscriptionPeriodEnd prop
- Modified: `/app/(app)/settings/page.tsx` - Fetch subscription data from user_subscriptions table
- Created: `/tests/unit/settings/BillingSection.test.tsx` - Unit tests for BillingSection
- Created: `/tests/unit/subscription/status.test.ts` - Unit tests for subscription utilities
- Created: `/tests/integration/api/billing-portal.test.ts` - Integration tests for billing portal API

## QA Results

_To be populated after QA review_
