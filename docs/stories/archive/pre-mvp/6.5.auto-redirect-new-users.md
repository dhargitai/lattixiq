# Story 6.5: Auto-Redirect New Users - Brownfield Addition

## Status

Done

## Story

**As a** authenticated user without any roadmaps,
**I want** to be automatically redirected to /new-roadmap,
**so that** I can immediately start creating my first learning journey without manual navigation.

## Story Context

**Existing System Integration:**

- Integrates with: `middleware.ts` auth flow and Supabase client
- Technology: Next.js middleware with Supabase SSR
- Follows pattern: Existing auth-based redirect logic in middleware
- Touch points: Database roadmap queries, auth user session

## Acceptance Criteria

**Functional Requirements:**

1. Authenticated users with 0 roadmaps are automatically redirected to `/new-roadmap`
2. Users with existing roadmaps continue to their intended destination normally
3. Redirect only occurs for protected routes, not for `/new-roadmap` or auth routes

**Integration Requirements:**

4. Existing auth redirect functionality continues to work unchanged
5. New functionality follows existing middleware redirect pattern
6. Integration with Supabase client maintains current behavior

**Quality Requirements:**

7. Change is covered by appropriate tests
8. Performance impact is minimal (efficient count query)
9. No regression in existing authentication functionality verified

## Technical Notes

- **Integration Approach:** Add roadmap count check to existing middleware after user authentication
- **Existing Pattern Reference:** Follow auth redirect pattern in `middleware.ts:38-52`
- **Key Constraints:** Must not interfere with existing auth flows, minimal performance impact

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Tasks / Subtasks

- [ ] Add roadmap count query to middleware (AC: 1)
  - [ ] Import roadmap query helper function
  - [ ] Add efficient count query after user auth
  - [ ] Handle query errors gracefully
- [ ] Implement redirect logic for new users (AC: 1, 3)
  - [ ] Check if roadmap count is 0
  - [ ] Redirect to /new-roadmap for new users
  - [ ] Skip redirect for /new-roadmap and auth routes
  - [ ] Preserve existing route access for users with roadmaps
- [ ] Maintain existing auth flow (AC: 4, 5, 6)
  - [ ] Ensure unauthenticated user redirects still work
  - [ ] Maintain auth route redirects for logged-in users
  - [ ] Follow existing middleware response pattern
- [ ] Write tests (AC: 7, 9)
  - [ ] Test new user redirect behavior
  - [ ] Test existing user normal flow
  - [ ] Test auth flow regression
  - [ ] Test performance impact

## Dev Notes

### API Specifications

Roadmap count query:

```typescript
const { count } = await supabase
  .from("roadmaps")
  .select("*", { count: "exact", head: true })
  .eq("user_id", user.id);
```

[Source: lib/db/toolkit.ts#40-80]

### Integration Points

**Middleware Flow:**

1. Create Supabase client
2. Get authenticated user
3. **NEW: Check roadmap count for authenticated users**
4. Apply redirect logic
5. Return supabaseResponse

[Source: middleware.ts#4-63]

### Technical Constraints

- Must use existing Supabase client pattern in middleware
- Preserve middleware response object requirements
- Minimal performance impact with efficient query
- Handle edge cases (network errors, query failures)

[Source: architecture/2-tech-stack.md]

### Security Considerations

- Only applies to authenticated users
- No additional security concerns
- Maintains existing auth protections

[Source: epic-6-settings-preferences.md#security-considerations]

## Testing

### Testing Standards

- Test file: `/tests/unit/middleware/auto-redirect.test.ts`
- Mock Supabase client responses
- Test various user states (new vs existing)
- Verify no regression in auth flow

[Source: architecture/12-coding-standards.md#testing-standards]

## Change Log

| Date       | Version | Description                       | Author        |
| ---------- | ------- | --------------------------------- | ------------- |
| 2025-08-07 | 1.0     | Initial brownfield story creation | Product Owner |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-20250514 (Sonnet 4)

### Debug Log References

No debug issues encountered during implementation.

### Completion Notes List

- ✅ Successfully implemented auto-redirect functionality for new users (0 roadmaps)
- ✅ Added efficient database count query with error handling
- ✅ Maintained all existing auth flow functionality without regression
- ✅ Added comprehensive unit tests covering all scenarios
- ✅ Code passes linting and type checking
- ✅ Implementation follows existing middleware patterns and coding standards

### File List

- **Modified**: `middleware.ts` - Added getUserRoadmapCount helper function and auto-redirect logic
- **Created**: `tests/unit/middleware/auto-redirect.test.ts` - Comprehensive test suite covering all scenarios

## QA Results

_To be filled by QA Agent_
