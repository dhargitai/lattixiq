# Story 4.3: Implement Testimonial Reward System (Senja.io Integration)

## Status

Done

## Story

**As a** user  
**I want** to get an additional roadmap for leaving a testimonial  
**So that** I can continue learning before committing to subscription

## Acceptance Criteria

1. Testimonial card appears at top of My Toolkit screen after first roadmap completion
2. Clearly states this is a one-time offer
3. Embeds Senja.io form for testimonial collection
4. Instructs users to use same email for identification
5. Card can be dismissed (offer expires)
6. Manual process grants bonus roadmap within ~1 day
7. Can't be exploited for multiple bonuses

## Tasks / Subtasks

- [x] Create TestimonialCard component (AC: 1, 2, 3, 4, 5)
  - [x] Create `/components/features/testimonial/TestimonialCard.tsx`
  - [x] Design card matching "Serene Minimalist" aesthetic from prototypes
  - [x] Embed Senja.io form using provided iframe code
  - [x] Add instructions for users to use same email as login
  - [x] Add "One-time offer" messaging with manual process note
  - [x] Implement close/dismiss button
  - [x] Use shadcn/ui Card component as base

- [x] Integrate Senja.io embed script (AC: 3)
  - [x] Add iframe resizer script to component
  - [x] Configure iframe with proper attributes
  - [x] Ensure responsive width and appropriate height
  - [x] Set allow="camera;microphone" for testimonial recording

- [x] Update roadmap completion flow (AC: 1)
  - [x] Modify completion logic to check if first roadmap
  - [x] Set flag to trigger testimonial card display
  - [x] Store trigger state in user preferences

- [x] Add testimonial card display logic to toolkit page (AC: 1, 5)
  - [x] Update `/app/(app)/toolkit/page.tsx`
  - [x] Check testimonial trigger conditions on page load
  - [x] Display TestimonialCard at top when conditions are met
  - [x] Handle card dismissal and store dismissal state
  - [x] Prevent re-showing after dismissal

- [x] Update testimonial bonus checking (AC: 6, 7)
  - [x] Update `/lib/subscription/check-limits.ts`
  - [x] Check testimonial_url field (manually updated by admin)
  - [x] Honor testimonial_bonus_used flag
  - [x] Ensure bonus only applies once per user

- [x] Add dismissal tracking (AC: 5)
  - [x] Store dismissal state (user preferences)
  - [x] Implement second trigger logic (3+ roadmaps with high ratings)
  - [x] Ensure card doesn't show after second dismissal

- [x] Write comprehensive tests (AC: 1-7)
  - [x] Unit tests for testimonial trigger logic
  - [x] Component tests for TestimonialCard
  - [x] Integration tests for toolkit page display logic
  - [x] Test dismissal state persistence
  - [x] Test bonus limit enforcement

## Dev Notes

### Previous Story Insights

From Story 4.2 completion:

- User tracking fields already exist: testimonial_bonus_used, testimonial_url
- Subscription checking utilities at `/lib/subscription/check-limits.ts` ready for integration
- QuickActions component handles premium gating on toolkit page
- Database functions handle atomic roadmap creation with tracking

### Key Implementation Change: Senja.io Integration

**Instead of custom database implementation:**

- Using Senja.io third-party service for testimonial collection
- No testimonials table needed in database
- No API endpoints for testimonial submission
- Manual process for granting bonus roadmaps

### Senja.io Embed Code

```html
<script type="text/javascript" src="https://widget.senja.io/js/iframeResizer.min.js"></script>
<iframe
  id="senja-collector-iframe"
  src="https://senja.io/p/lattixiq/r/eOsaq7?mode=embed&nostyle=true"
  allow="camera;microphone"
  title="Senja form"
  frameborder="0"
  scrolling="no"
  width="100%"
  height="700"
>
</iframe>
<script type="text/javascript">
  iFrameResize({ log: false, checkOrigin: false }, "#senja-collector-iframe");
</script>
```

### Manual Admin Process

1. User submits testimonial through Senja.io form (using same email as login)
2. Admin periodically checks Senja.io dashboard for new testimonials
3. Admin manually updates user.testimonial_url field in database
4. User gains access to bonus roadmap (process takes ~1 day as communicated)

### Component Specifications

**TestimonialCard Component** [Source: prototypes/my-toolkit.html#69-149]:

- Background gradient: `linear-gradient(135deg, #EBF4FF 0%, #E6F7FF 100%)`
- Border: `1px solid #BEE3F8`
- Border radius: 16px
- Padding: 24px
- Margin bottom: 32px
- Close button in top-right (32x32px circle)
- Animation: slideIn 0.4s ease-out
- Min height to accommodate Senja iframe (700px)

### Frontend Alignment

Based on frontend-spec [Source: docs/frontend-spec.md#146-161]:

- Card appears at top of My Toolkit screen (not modal)
- Trigger 1: After first roadmap completion
- Trigger 2: After 3+ roadmaps with high ratings if first was dismissed
- Clear dismissal tracking to prevent re-showing
- Congratulatory messaging for trigger 1
- Adapted messaging for trigger 2

### File Locations

Based on project structure [Source: architecture/10-unified-project-structure.md]:

- Component: `/components/features/testimonial/TestimonialCard.tsx`
- Page updates: `/app/(app)/toolkit/page.tsx`
- Utility updates: `/lib/subscription/check-limits.ts`

### Testing Requirements

[Source: architecture/11-testing-strategy.md]:

- Component tests: `/tests/unit/components/testimonial-card.test.tsx`
- Integration tests: `/tests/integration/testimonial-flow.test.ts`
- Use Vitest for unit/integration tests
- Test naming: `should [expected behavior] when [condition]`

Test scenarios to cover:

- Happy: First roadmap completion triggers card
- Happy: Card displays Senja form correctly
- Happy: Dismissal prevents re-showing
- Happy: Second trigger after sustained success
- Unhappy: Card doesn't show for incomplete roadmaps
- Unhappy: Card doesn't show after second dismissal

### Technical Constraints

- Follow functional programming style [Source: architecture/12-coding-standards.md#8-23]
- Use shadcn/ui components (v2.0.0) [Source: architecture/2-tech-stack.md#9]
- Tailwind CSS v4.0.0 for styling [Source: architecture/2-tech-stack.md#10]
- No direct database writes from client [Source: architecture/12-coding-standards.md#182-212]

### Security Considerations

- No sensitive data stored client-side
- Manual admin process prevents automated exploitation
- Existing testimonial_bonus_used flag prevents multiple bonuses

### Implementation Notes

1. **Senja Integration**: Embed provided iframe code directly in TestimonialCard
2. **User Instructions**: Clear messaging about using same email for identification
3. **Manual Process Communication**: Set expectation of ~1 day processing time
4. **Dismissal Logic**: Store in user preferences
5. **Trigger Logic**: Check roadmap completion count and ratings for second trigger
6. **Card Positioning**: Display at top of My Toolkit screen above other content

## Testing

### Testing Standards

[Source: architecture/11-testing-strategy.md]:

- Test file locations:
  - `/tests/unit/components/testimonial-card.test.tsx` - Component tests
  - `/tests/integration/testimonial-flow.test.ts` - Flow tests
- Use Vitest for test runner
- Mock Senja iframe in tests
- Test naming convention: `should [expected behavior] when [condition]`

### Key Test Scenarios

1. Testimonial card appears after first roadmap completion
2. Card displays at top of My Toolkit screen
3. Senja form embeds correctly
4. Card shows one-time offer messaging
5. Dismissal prevents card from re-appearing
6. Second trigger works after sustained success
7. Manual bonus process instructions are clear
8. Card doesn't appear for users with active subscription

## Change Log

| Date       | Version | Description                              | Author             |
| ---------- | ------- | ---------------------------------------- | ------------------ |
| 2025-01-08 | 1.0     | Initial story creation                   | Scrum Master (Bob) |
| 2025-01-08 | 2.0     | Revised for Senja.io integration (no DB) | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References

- Fixed TypeScript type errors for testimonial_state field usage
- Resolved linting issues with proper type definitions
- Fixed async test timing issue in TestimonialCard tests
- Integration tests require local Supabase running

### Completion Notes List

1. Successfully created TestimonialCard component with Senja.io iframe integration
2. Implemented dismissal tracking using testimonial_state enum
3. Added trigger logic for first completion and sustained success milestones
4. Updated toolkit page to display testimonial card conditionally
5. Enhanced subscription checking to honor testimonial bonus
6. Created comprehensive unit and integration tests
7. All linting and type checking pass successfully

### File List

**Created:**

- `/components/features/testimonial/TestimonialCard.tsx` - Main testimonial card component with Senja iframe
- `/tests/unit/components/testimonial-card.test.tsx` - Unit tests for TestimonialCard component
- `/tests/integration/testimonial-display.test.ts` - Integration tests for display logic

**Modified:**

- `/lib/db/toolkit.ts` - Added testimonial card display logic and trigger detection
- `/components/features/toolkit/TestimonialPromptWrapper.tsx` - Updated to use new TestimonialCard component
- `/lib/subscription/check-limits.ts` - Fixed getTestimonialBonus function to properly check for bonus availability

## QA Results

_To be populated after QA review_
