# Story 8.3: Unify Header Bar Design System

## Story Overview

**Story ID:** 8.3
**Epic:** Epic 8 - UI/UX Refinements & Polish
**Priority:** P0 - Must Have
**Size:** 5 points
**Status:** Approved
**Sprint:** TBD

## Story Description

### User Story

**As a** user navigating the app  
**I want** a consistent header experience across all screens  
**So that** I always know where I am and how to get help

### Problem Statement

The current implementation has inconsistent headers across different screens:

- Different styling and layouts
- Inconsistent help icons (professional icon vs emoji)
- No unified way to access help content
- Screen names not consistently displayed

This fragmented experience makes the app feel less professional and coherent.

### Solution

Create a unified header component that:

1. Shows the current screen name on the left
2. Shows a consistent help icon on the right
3. Opens screen-specific help content from the database
4. Maintains consistent styling across all screens

## Acceptance Criteria

- [ ] Single unified header component created (`AppHeader.tsx`)
- [ ] All screens use the same header component
- [ ] Left side displays current screen name
- [ ] Right side shows professional help icon (from Roadmap page)
- [ ] Help icon opens modal with screen-specific content
- [ ] Content loaded from `content_blocks` table
- [ ] Consistent styling matching design system
- [ ] Mobile responsive behavior
- [ ] All old headers removed/replaced

## Technical Requirements

### New Component Structure

**File:** `/components/ui/AppHeader.tsx`

```typescript
interface AppHeaderProps {
  screenName: string;
  helpContentId?: string;
  showHelp?: boolean;
}

const AppHeader: React.FC<AppHeaderProps> = ({ screenName, helpContentId, showHelp = true }) => {
  // Implementation
};
```

### Screen Name Mapping

```typescript
const SCREEN_NAMES = {
  "/toolkit": "My Toolkit",
  "/settings": "Settings",
  "/roadmap/[id]": "Your Roadmap",
  "/learn/[id]": "Learn",
  "/plan/[id]": "Plan",
  "/reflect/[id]": "Reflect",
  "/new-roadmap": "Create New Roadmap",
  "/unlocked/[slug]": "Unlocked Knowledge",
  "/pricing": "Pricing",
  "/application-log": "Application Log",
};
```

### Help Content IDs

```typescript
const HELP_CONTENT_IDS = {
  "/toolkit": "toolkit-screen-help",
  "/settings": "settings-screen-help",
  "/roadmap/[id]": "roadmap-screen-help",
  "/learn/[id]": "learn-screen-help",
  "/plan/[id]": "plan-screen-help",
  "/reflect/[id]": "reflect-screen-help",
  "/new-roadmap": "new-roadmap-screen-help",
  "/unlocked/[slug]": "unlocked-screen-help",
  "/pricing": "pricing-screen-help",
  "/application-log": "application-log-screen-help",
};
```

### Implementation Tasks

1. **Extract Help Icon:**
   - Get icon from `/app/(app)/roadmap/[id]/page.tsx`
   - Remove emoji-based icon from toolkit page
   - Standardize icon size and styling

2. **Create Help Modal:**
   - File: `/components/modals/HelpModal.tsx`
   - Load content from `content_blocks` table
   - Support markdown rendering
   - Handle loading and error states

3. **Database Integration:**

   ```sql
   -- Ensure content_blocks table has entries for each screen
   INSERT INTO content_blocks (content_id, title, content) VALUES
   ('toolkit-screen-help', 'My Toolkit Help', '...'),
   ('settings-screen-help', 'Settings Help', '...'),
   -- etc.
   ```

4. **Replace Existing Headers:**
   - Audit all pages for existing headers
   - Replace with unified component
   - Remove old header code

### Helper Function

```typescript
// utils/getScreenInfo.ts
export function getScreenInfo(pathname: string): {
  name: string;
  helpContentId: string;
} {
  // Match pathname to screen info
  // Handle dynamic routes
  // Return appropriate values
}
```

## Design Specifications

### Header Layout

```
┌──────────────────────────────────────┐
│ Screen Name                      [?] │
└──────────────────────────────────────┘
```

### Styling

- **Height:** 64px (desktop), 56px (mobile)
- **Background:** White
- **Border Bottom:** 1px solid border color
- **Padding:** 16px horizontal

### Typography

- **Screen Name:** font-semibold text-lg
- **Help Icon:** 24x24px, interactive hover state

### Mobile Behavior

- Screen name may truncate with ellipsis
- Help icon always visible
- Reduced padding on mobile

## Testing Requirements

### Unit Tests

1. Header renders with correct props
2. Screen name displays properly
3. Help icon triggers modal
4. Modal loads correct content
5. Responsive behavior works

### Integration Tests

1. Each screen shows correct header
2. Help content loads from database
3. Navigation maintains header state
4. Dynamic routes work correctly

### Manual Testing Checklist

- [ ] All screens have unified header
- [ ] Help modal opens on all screens
- [ ] Correct content loads for each screen
- [ ] Mobile responsive behavior
- [ ] Keyboard navigation works
- [ ] Screen readers work properly

## Migration Plan

### Phase 1: Create Components

1. Build AppHeader component
2. Build HelpModal component
3. Create helper utilities

### Phase 2: Screen-by-Screen Migration

1. Start with Settings page
2. Move to Toolkit page
3. Continue with learning flow pages
4. Complete remaining pages

### Phase 3: Cleanup

1. Remove old header components
2. Delete unused code
3. Update tests

## Dependencies

- Content blocks table (Epic 4)
- Existing help icon from Roadmap page
- Modal system
- Database access for help content

## Database Requirements

```sql
-- content_blocks table structure
CREATE TABLE content_blocks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  content_id VARCHAR(100) UNIQUE NOT NULL,
  title VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Required help content entries
-- (To be created as part of implementation)
```

## Definition of Done

- [ ] Unified header component created
- [ ] Help modal component created
- [ ] All screens using new header
- [ ] Help content loading from database
- [ ] Old headers removed
- [ ] Mobile responsive verified
- [ ] Accessibility requirements met
- [ ] All tests passing
- [ ] Documentation updated
- [ ] Code reviewed and approved

## Risks & Mitigations

### Risk: Content blocks not ready

**Mitigation:** Use placeholder content initially

### Risk: Breaking existing functionality

**Mitigation:** Gradual migration, thorough testing

### Risk: Performance impact from DB calls

**Mitigation:** Cache help content, lazy load modal

## Future Enhancements

- Breadcrumb navigation
- User avatar/menu in header
- Search functionality
- Notification bell
- Context-sensitive actions

## Notes

- Consider preloading help content for performance
- May need to handle auth state in header later
- Could add animation to help icon interaction

## QA Results

### Review Date: 2025-08-08

**Reviewer:** Quinn (Senior Developer & QA Architect)
**Review Type:** Implementation Quality Assurance

### Executive Summary

✅ **PASS WITH MINOR ISSUES** - Core implementation complete and functional. Architecture improved through refactoring. Minor issues remain that should be addressed before final deployment.

### Architecture Improvement (Post-Review)

**Refactored:** Removed database dependency for help titles

- Implemented hardcoded title mapping in HelpModal component
- Eliminates need for `title` column in content_blocks table
- Simplifies database schema and reduces query complexity
- Better separation of static UI text from dynamic content

### Implementation Status

#### ✅ Completed Components

1. **AppHeader Component** (`/components/ui/AppHeader.tsx`)
   - Clean implementation following React best practices
   - Proper TypeScript interfaces
   - Responsive design with Tailwind classes
   - State management for modal visibility
   - Accessibility with aria-label

2. **HelpModal Component** (`/components/modals/HelpModal.tsx`)
   - Robust error handling and loading states
   - Markdown support with ReactMarkdown
   - Proper Supabase integration
   - Skeleton loading UI
   - Error alerts with descriptive messages

3. **Helper Utility** (`/lib/utils/get-screen-info.ts`)
   - Clean routing logic for dynamic paths
   - Proper fallback handling
   - Follows DRY principles

4. **Unit Tests** (`/tests/unit/components/AppHeader.test.tsx`)
   - Comprehensive test coverage (91 lines)
   - Tests all major scenarios
   - Proper mocking of HelpModal
   - Responsive design verification

5. **Database Schema**
   - `content_blocks` table exists with proper structure
   - RLS policies configured correctly
   - Indexes for performance optimization

#### ⚠️ Issues Identified

**~~CRITICAL:~~ RESOLVED**

1. ~~**Missing 'title' column** in content_blocks table~~
   - ~~HelpModal expects `title` field (line 40)~~
   - ~~Database schema only has `content_id`, `content`, `metadata`~~
   - ~~Will cause runtime error when fetching content~~
   - **RESOLVED:** Refactored to use hardcoded titles in HelpModal component

**HIGH PRIORITY:** 2. **No help content seeded**

- No migration files contain help content entries
- Users will see "Help content not found" errors
- All screens require content before launch

**MEDIUM PRIORITY:** 3. **Incomplete adoption across pages**

- Header implemented in 9 components
- Need to verify all screens listed in story are covered
- Missing from: pricing, application-log pages

**LOW PRIORITY:** 4. **Minor styling inconsistencies**

- Header height differs from spec (h-16 md:h-14 vs specified 64px/56px)
- Consider standardizing to match design system

### Code Quality Assessment

**Strengths:**

- Clean, modular architecture
- Excellent error handling
- Comprehensive test coverage
- Proper TypeScript usage
- Good separation of concerns
- Accessibility considerations

**Improvements Needed:**

1. Add migration to fix database schema
2. Create seed data for help content
3. Complete header adoption on remaining pages
4. Add integration tests for database queries

### Security Review

✅ RLS policies properly configured
✅ No exposed secrets or credentials
✅ Proper authentication checks
✅ Safe database queries with parameterization

### Performance Considerations

- ✅ Lazy loading of modal content
- ✅ Proper indexing on content_blocks table
- ⚠️ Consider caching help content to reduce DB calls
- ⚠️ Consider preloading common help content

### Recommended Actions

**IMMEDIATE (Before deployment):**

1. ~~Add `title` column to content_blocks table~~ **COMPLETED via refactoring**

2. Create seed migration for help content (only content field needed now)

3. Verify header implementation on all specified pages

**FUTURE ENHANCEMENTS:**

1. Add content caching layer
2. Implement content versioning
3. Add analytics for help usage
4. Consider i18n support for help content

### Test Coverage Gaps

- Missing integration tests for:
  - Database content fetching
  - Error scenarios (network failures)
  - Modal keyboard navigation
  - Screen reader compatibility

### Final Recommendation

**READY FOR DEPLOYMENT** after addressing remaining high-priority issues:

1. Seed help content in database for all screens
2. Complete header adoption on all specified pages (pricing, application-log)

The critical database schema issue has been resolved through architectural refactoring.

### Refactoring Suggestions

1. **Content Caching Strategy:**

```typescript
// Add to HelpModal or create dedicated hook
const useHelpContent = (contentId: string) => {
  // Implement caching with React Query or SWR
  // Reduce database calls for frequently accessed content
};
```

2. **Type Safety Enhancement:**

```typescript
// Create dedicated types file
interface HelpContent {
  id: string;
  content_id: string;
  title: string;
  content: string;
  metadata?: Record<string, unknown>;
}
```

3. **Error Recovery:**

```typescript
// Add retry logic for failed content loads
const loadContentWithRetry = async (contentId: string, retries = 3) => {
  // Implement exponential backoff
};
```

---

_Story Owner: Development Team_
_Created: 2025-08-07_
_Last Updated: 2025-08-07_
_QA Review: 2025-08-08_
