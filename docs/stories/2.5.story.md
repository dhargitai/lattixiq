# Story 2.5: Build Reflect Screen - Capture Learning Experience and Unlock Progress

## Status

Draft

## Story

**As a** user who tried applying a mental model or spotting a cognitive bias in real life
**I want** to journal about my experience through structured reflection prompts
**So that** I can process what I learned, measure effectiveness, and unlock the next step in my roadmap

## Acceptance Criteria

1. Reflect screen displays when user navigates from reminder or directly accesses with active plan
2. Shows recap of user's original plan (situation, trigger, action) at the top
3. Presents structured reflection prompts in logical sequence
4. Includes "What happened?" text area for detailed experience description
5. Includes "What did you learn?" text area for insights and takeaways
6. Features 1-5 star effectiveness rating component for self-assessment
7. Includes "Would you use this again?" toggle for future application intent
8. Enforces minimum character count (100 characters) for meaningful reflection
9. Saves complete reflection data to application_logs table
10. Updates roadmap step status to 'completed' upon successful submission
11. Unlocks next roadmap step automatically after completion
12. Shows success animation and auto-navigates to updated roadmap view
13. Handles edge cases: incomplete plans, expired sessions, direct URL access
14. Mobile-responsive design with proper form validation and error handling

## Tasks / Subtasks

- [ ] Task 1: Write integration tests using TDD approach (AC: 1-14)
  - [ ] Create test file at `/app/(app)/reflect/[stepId]/__tests__/reflect.test.tsx`
  - [ ] Write test for authenticated access with active plan validation
  - [ ] Write test for displaying plan recap (situation, trigger, action)
  - [ ] Write test for structured reflection prompt sequence
  - [ ] Write test for form validation (minimum character counts)
  - [ ] Write test for effectiveness rating interaction
  - [ ] Write test for "would use again" toggle
  - [ ] Write test for saving reflection to application_logs table
  - [ ] Write test for roadmap step status update to 'completed'
  - [ ] Write test for unlocking next roadmap step
  - [ ] Write test for success flow and navigation
  - [ ] Write test for mobile responsive behavior
  - [ ] Write test for error handling (network failures, validation errors)
  - [ ] Write test for edge cases (no plan, expired session, direct access)

- [ ] Task 2: Set up reflect route and data validation (AC: 1, 13)
  - [ ] Create `/app/(app)/reflect/[stepId]/` directory structure
  - [ ] Create `page.tsx` with authentication and plan validation:
    ```typescript
    // Validate user has active plan for this step
    const { data: step } = await supabase
      .from("roadmap_steps")
      .select(
        `
        *,
        knowledge_content(*),
        roadmap:roadmaps!inner(user_id)
      `
      )
      .eq("id", stepId)
      .eq("roadmap.user_id", user.id)
      .not("plan_created_at", "is", null) // Must have a plan
      .single();
    ```
  - [ ] Implement plan recap data fetching and validation
  - [ ] Add route guards for edge cases (no plan, already reflected)
  - [ ] Handle loading and error states with proper redirects

- [ ] Task 3: Create ReflectScreen component (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create `/components/features/roadmap/ReflectScreen.tsx`
  - [ ] Follow component template pattern with forwardRef
  - [ ] Implement plan recap section:
    - Mental model/bias title with icon
    - Original plan details (situation, trigger, action) in card format
    - Clear visual separation from reflection form
  - [ ] Create structured reflection form:
    - "What happened when you tried this?" text area
    - "What did you learn about yourself or the situation?" text area
    - Star rating component (1-5) for effectiveness
    - "Would you use this approach again?" toggle
  - [ ] Add form validation with real-time feedback
  - [ ] Implement character count indicators with minimum thresholds

- [ ] Task 4: Build reflection form components (AC: 4, 5, 6, 7, 8)
  - [ ] Create star rating component `/components/ui/StarRating.tsx`:
    ```typescript
    interface StarRatingProps {
      value: number;
      onChange: (rating: number) => void;
      disabled?: boolean;
      size?: "sm" | "md" | "lg";
    }
    ```
  - [ ] Create character counter component for text areas
  - [ ] Add helpful placeholder text and prompts:
    - "What happened?": "Describe the situation when you tried to apply this..."
    - "What did you learn?": "What insights did you gain? What would you do differently?"
  - [ ] Implement progressive disclosure for complex reflections
  - [ ] Add form state management with unsaved changes warning

- [ ] Task 5: Implement reflection submission and progress logic (AC: 9, 10, 11)
  - [ ] Create API route `/app/api/roadmap-steps/[stepId]/reflect/route.ts`
  - [ ] Implement reflection submission handler:

    ```typescript
    // Save to application_logs table
    const { data: applicationLog } = await supabase
      .from("application_logs")
      .insert({
        user_id: user.id,
        roadmap_step_id: stepId,
        situation_text: reflection.whatHappened,
        learning_text: reflection.whatLearned,
        effectiveness_rating: reflection.rating,
        // ai_sentiment and ai_topics will be populated by background job
      })
      .select()
      .single();

    // Update step status to completed
    await supabase.from("roadmap_steps").update({ status: "completed" }).eq("id", stepId);

    // Unlock next step if exists
    await supabase
      .from("roadmap_steps")
      .update({ status: "unlocked" })
      .eq("roadmap_id", step.roadmap_id)
      .eq("order", step.order + 1);
    ```

  - [ ] Add transaction handling for atomic updates
  - [ ] Implement retry logic for network failures

- [ ] Task 6: Create success flow and navigation (AC: 12)
  - [ ] Design completion animation using Framer Motion
  - [ ] Create success message with reflection summary
  - [ ] Implement celebration micro-interaction (confetti, progress indicator)
  - [ ] Add "Continue to Next Step" button with smooth transition
  - [ ] Auto-redirect to roadmap after 3 seconds with countdown
  - [ ] Update breadcrumb navigation state

- [ ] Task 7: Add reflection content analysis hooks (AC: 9)
  - [ ] Create background job trigger for AI sentiment analysis
  - [ ] Set up webhook or queue for processing reflection content:
    ```typescript
    // Trigger analysis after reflection saved
    await fetch("/api/ai/analyze-reflection", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        applicationLogId: applicationLog.id,
        reflectionText: `${reflection.whatHappened}\n\n${reflection.whatLearned}`,
      }),
    });
    ```
  - [ ] Handle analysis failures gracefully (reflection still saves)
  - [ ] Add progress indicator for analysis completion

- [ ] Task 8: Implement state management and caching (AC: 1, 13)
  - [ ] Update `/lib/stores/roadmap-store.ts` with reflection state:
    ```typescript
    interface ReflectionState {
      currentReflection: {
        stepId: string;
        whatHappened: string;
        whatLearned: string;
        rating: number;
        wouldUseAgain: boolean;
      } | null;
      setReflectionDraft: (draft: Partial<ReflectionState["currentReflection"]>) => void;
      clearReflection: () => void;
      isSubmitting: boolean;
    }
    ```
  - [ ] Implement auto-save for reflection drafts
  - [ ] Add data persistence for offline scenarios
  - [ ] Handle state cleanup after successful submission

- [ ] Task 9: Polish and accessibility (AC: 14)
  - [ ] Add comprehensive loading states for all async operations
  - [ ] Implement proper error boundaries with user-friendly messages
  - [ ] Add keyboard navigation for all interactive elements
  - [ ] Ensure proper focus management throughout form
  - [ ] Add ARIA labels and descriptions for screen readers
  - [ ] Test with screen readers (VoiceOver, NVDA)
  - [ ] Verify color contrast ratios for all text
  - [ ] Add haptic feedback for mobile interactions

- [ ] Task 10: Create reflection analytics and insights (AC: 9)
  - [ ] Add analytics tracking for reflection completion rates
  - [ ] Track effectiveness rating distributions
  - [ ] Monitor character count trends and engagement metrics
  - [ ] Create reflection insights for user dashboard
  - [ ] Add data for future AI coaching recommendations

- [ ] Task 11: Verify all tests pass and user flow works (AC: 1-14)
  - [ ] Run full test suite with all new tests
  - [ ] Test complete Learn → Plan → Reflect → Next Step flow
  - [ ] Verify mobile responsive design on various devices
  - [ ] Test offline scenarios and network error handling
  - [ ] Performance testing for form interactions and animations
  - [ ] Cross-browser compatibility testing
  - [ ] User acceptance testing with sample reflections

## Dev Notes

### Previous Story Insights

From Story 2.1 (Learn Screen):

- Established component patterns with forwardRef and TypeScript interfaces
- Database queries use snake_case fields directly (e.g., `knowledge_content_id`)
- Loading states handled via Next.js patterns (loading.tsx, error.tsx)
- Mobile-first responsive design approach with Tailwind CSS

From Story 2.4 (Reminder System):

- Users access reflect screen via notifications with deep linking
- Plans stored in roadmap_steps with `plan_situation`, `plan_trigger`, `plan_action` fields
- Only steps with `plan_created_at` (active plans) should allow reflection
- Reflection completion should stop further reminder notifications

From Epic 2 requirements:

- Story 2.5 has 8 story points (medium complexity)
- Reflection is the key touchpoint for learning and progress
- Success metric: 70% of users should complete their first reflection
- Effectiveness rating average should be >3.5 stars

### Architecture Requirements

**Data Flow Design:**
Following architecture/3-data-models.md:

- Reflection data stored in `application_logs` table
- Links to user via `user_id` and step via `roadmap_step_id`
- AI analysis fields (`ai_sentiment`, `ai_topics`) populated asynchronously
- Progress tracking via roadmap step status updates

**Component Architecture:**
Following established patterns from Learn screen:

- Use `React.forwardRef` for all components
- TypeScript interfaces extending HTML attributes
- Consistent use of `cn()` utility for class merging
- Place in `/components/features/roadmap/` directory

### Data Models

**Application Log Interface:**

```typescript
interface ApplicationLogInsert {
  user_id: string;
  roadmap_step_id: string;
  situation_text: string; // "What happened?" response
  learning_text: string; // "What did you learn?" response
  effectiveness_rating: number; // 1-5 star rating
  ai_sentiment?: AISentiment; // Populated by background job
  ai_topics?: string[]; // Populated by background job
}
```

**Reflection Form State:**

```typescript
interface ReflectionFormData {
  whatHappened: string; // Minimum 100 characters
  whatLearned: string; // Minimum 100 characters
  effectivenessRating: number; // 1-5 stars
  wouldUseAgain: boolean; // Toggle for future intent
}
```

**Plan Recap Display:**

```typescript
interface PlanRecapProps {
  knowledgeContent: KnowledgeContent;
  planSituation: string;
  planTrigger: string;
  planAction: string;
  planCreatedAt: string;
}
```

### Route Structure

New route to be created:

```text
/app/(app)/reflect/[stepId]/
├── page.tsx              # Main reflect page with validation
├── loading.tsx           # Loading skeleton
├── error.tsx            # Error boundary
└── __tests__/           # Integration tests
    └── reflect.test.tsx
```

### UI Design Guidelines

**Reflection Form Layout:**

- Plan recap card at top with subtle styling
- Progressive form with clear section breaks
- Star rating with hover states and accessibility
- Character counters with color coding (red < minimum, green ≥ minimum)
- Large text areas for comfortable writing
- Sticky submit button for mobile UX

**Success Flow Design:**

- Celebration animation (confetti or progress burst)
- Clear success message with reflection summary
- Prominent "Continue to Next Step" CTA
- Auto-redirect with countdown timer
- Breadcrumb updates to show progress

### Form Validation Strategy

**Client-Side Validation:**

- Real-time character count validation
- Required field highlighting
- Star rating selection validation
- Unsaved changes warning on navigation

**Server-Side Validation:**

- Minimum character count enforcement (100 chars each field)
- User ownership verification
- Plan existence validation
- Duplicate reflection prevention

### Success Animation Implementation

Using Framer Motion for micro-interactions:

```typescript
const SuccessAnimation = () => (
  <motion.div
    initial={{ scale: 0, opacity: 0 }}
    animate={{ scale: 1, opacity: 1 }}
    transition={{ type: "spring", duration: 0.6 }}
  >
    {/* Celebration content */}
  </motion.div>
);
```

### Testing Strategy

**Integration Tests Priority:**

- Complete reflection submission flow
- Plan recap display accuracy
- Form validation edge cases
- Progress unlocking logic
- Navigation state management

**User Journey Testing:**

- Learn → Plan → Reflect complete flow
- Reflection via reminder notification
- Mobile form interaction patterns
- Offline/online state transitions

### Performance Considerations

**Form Optimization:**

- Debounced auto-save for drafts
- Optimistic UI updates for better perceived performance
- Lazy loading for heavy animation components
- Text area resize optimization

**Database Optimization:**

- Single transaction for reflection save + progress update
- Efficient queries for plan recap data
- Background job for AI analysis to avoid blocking UI

### Security Considerations

**Data Validation:**

- Sanitize reflection text content
- Validate step ownership before allowing reflection
- Rate limiting on reflection submission
- CSRF protection on form submission

**Privacy:**

- Reflection content encrypted at rest
- User consent for AI analysis
- Data retention policies for sensitive reflections

### File Locations

**To be created:**

- `/app/(app)/reflect/[stepId]/page.tsx` - Main reflect page
- `/app/(app)/reflect/[stepId]/loading.tsx` - Loading state
- `/app/(app)/reflect/[stepId]/error.tsx` - Error boundary
- `/components/features/roadmap/ReflectScreen.tsx` - Main component
- `/components/ui/StarRating.tsx` - Star rating component
- `/app/api/roadmap-steps/[stepId]/reflect/route.ts` - Submission API
- `/app/(app)/reflect/[stepId]/__tests__/reflect.test.tsx` - Integration tests

**To be modified:**

- `/lib/stores/roadmap-store.ts` - Add reflection state management
- `/lib/queries/roadmap-queries.ts` - Add reflection-related queries

### Technical Constraints

- Next.js 15.4.5 with App Router
- React 19.1.0 with concurrent features
- TypeScript with strict mode enabled
- Supabase for data persistence and RLS
- Framer Motion for animations
- Tailwind CSS v4 for styling

[Source: architecture/2-tech-stack.md#Frontend Stack]

### Risk Mitigation

**Form Data Loss:**

- Auto-save drafts every 30 seconds
- Browser storage backup for offline scenarios
- Warning before navigation with unsaved changes
- Recovery mechanism for interrupted submissions

**Progress Logic Errors:**

- Atomic transactions for step completion + next step unlock
- Rollback mechanisms for failed operations
- Validation of roadmap step sequence integrity
- Monitoring for stuck or corrupted step states

### Success Metrics

- 70% of users complete their first reflection (Epic success criteria)
- Average effectiveness rating >3.5 stars
- <10% reflection abandonment rate after starting
- Average reflection length >200 characters per text area
- <2 second form submission response time

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-08-04 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
