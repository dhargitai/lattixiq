# Story 8.4: Add "Applying" State Indicator to Roadmap Steps

## Story Overview

**Story ID:** 8.4
**Epic:** Epic 8 - UI/UX Refinements & Polish
**Priority:** P1 - Should Have
**Size:** 3 points
**Status:** Approved
**Sprint:** TBD

## Story Description

### User Story

**As a** user who has planned but not yet reflected  
**I want** to see a clear indicator that I'm in the application phase  
**So that** I understand my current progress status

### Problem Statement

When users have saved a plan but haven't completed their reflection, there's no clear visual indicator that they're in the "applying" phase of the learning loop. The current UI doesn't distinguish between:

- Not started
- Learning in progress
- Applying the concept (post-plan, pre-reflection)
- Completed

This causes confusion about what action to take next.

### Solution

Add a visual "applying" state indicator to roadmap steps:

1. Show an hourglass emoji (⏳) when in applying phase
2. Display encouraging message about the mission
3. Update CTA text to reflect the appropriate next action

## Acceptance Criteria

- [x] Hourglass emoji (⏳) displays under step name when:
  - User has completed learning
  - User has saved a plan
  - User has NOT completed reflection
- [x] Message displays: "You're on a mission to apply what you learned"
- [x] CTA changes from "Start Learning" to "Reflect On What You Learned"
- [x] Indicator only shows for current active step
- [x] Visual styling consistent with existing design
- [x] Mobile responsive layout maintained
- [x] State transitions work correctly

## Technical Requirements

### State Detection Logic

```typescript
interface StepState {
  hasLearned: boolean;
  hasPlan: boolean;
  hasReflected: boolean;
  isComplete: boolean;
}

// Derived state
const isApplying = hasLearned && hasPlan && !hasReflected && !isComplete;
```

### Component Updates

**File:** `/components/roadmap/RoadmapStep.tsx` (or equivalent)

```typescript
const RoadmapStep = ({ step, isActive }) => {
  const isApplying = step.hasLearned && step.hasPlan && !step.hasReflected;

  return (
    <div className="step-container">
      <h3>{step.name}</h3>

      {isApplying && isActive && (
        <div className="applying-indicator">
          <span className="hourglass">⏳</span>
          <p className="applying-message">
            You're on a mission to apply what you learned
          </p>
        </div>
      )}

      <Link href={getStepLink(step)}>
        {getCtaText(step)}
      </Link>
    </div>
  );
};

const getCtaText = (step) => {
  if (!step.hasLearned) return "Start Learning";
  if (!step.hasPlan) return "Create Your Plan";
  if (!step.hasReflected) return "Reflect On What You Learned";
  return "View Step";
};

const getStepLink = (step) => {
  if (!step.hasLearned) return `/learn/${step.id}`;
  if (!step.hasPlan) return `/plan/${step.id}`;
  if (!step.hasReflected) return `/reflect/${step.id}`;
  return `/roadmap/${step.roadmapId}`;
};
```

### Database Query Updates

Ensure the step query includes all necessary fields:

```sql
SELECT
  s.*,
  s.completed_at IS NOT NULL as is_complete,
  EXISTS(SELECT 1 FROM step_progress WHERE step_id = s.id AND type = 'learn') as has_learned,
  EXISTS(SELECT 1 FROM step_plans WHERE step_id = s.id) as has_plan,
  EXISTS(SELECT 1 FROM step_reflections WHERE step_id = s.id) as has_reflected
FROM roadmap_steps s
WHERE s.roadmap_id = $1;
```

## Design Specifications

### Visual Layout

```
┌─────────────────────────────┐
│ Step Name                   │
│ ⏳ You're on a mission to   │
│ apply what you learned      │
│                             │
│ [Reflect On What You Learned]│
└─────────────────────────────┘
```

### Styling

- **Hourglass:** 20px font-size
- **Message:** text-sm, muted color (text-gray-600)
- **Spacing:** 8px between emoji and text
- **Container:** 12px margin top/bottom

### CTA Button Variations

| State                     | CTA Text                      |
| ------------------------- | ----------------------------- |
| Not started               | "Start Learning"              |
| Learning done, no plan    | "Create Your Plan"            |
| Plan saved, not reflected | "Reflect On What You Learned" |
| Complete                  | "Review" or disabled          |

## Testing Requirements

### Unit Tests

1. State detection logic correctly identifies applying phase
2. Hourglass only shows in applying state
3. CTA text changes based on state
4. Links point to correct pages

### Integration Tests

1. Full state transition flow:
   - Start → Learn → Plan → Apply → Reflect → Complete
2. Persistence across page refreshes
3. Multiple steps with different states

### Manual Testing

1. Visual appearance on different screen sizes
2. State transitions are smooth
3. Message is clear and encouraging
4. No layout shifts when indicator appears

## Edge Cases

1. **User skips learning:** Should not show applying state
2. **User deletes plan:** Should revert to pre-plan state
3. **Multiple active steps:** Only show on current step
4. **Completed roadmap:** No indicators shown

## Analytics Tracking

Track state transitions:

- `applying_state_entered` - When user enters applying phase
- `applying_state_duration` - Time spent in applying phase
- `reflection_started_from_applying` - Conversion rate

## Dependencies

- Step progress tracking in database
- Plan save functionality
- Reflection completion tracking
- Existing roadmap step components

## Definition of Done

- [x] Applying state correctly detected
- [x] Visual indicators display properly
- [x] CTA text updates based on state
- [x] Mobile responsive design maintained
- [x] All state transitions tested
- [x] No performance degradation
- [x] Accessibility maintained
- [ ] Code reviewed and approved
- [ ] Deployed to staging

## Future Enhancements

- Add time estimate for application phase
- Show days since plan was created
- Add reminder notifications for applying phase
- Include tips for successful application
- Progress bar for applying phase

## Notes

- Consider adding subtle animation to hourglass
- Message could be personalized based on concept type
- May want A/B testing on CTA text variations
- Consider color coding for different states

---

_Story Owner: Development Team_
_Created: 2025-08-07_
_Last Updated: 2025-08-08_

## Dev Agent Record

### Tasks Completed

- [x] Found and analyzed existing roadmap step components
- [x] Updated RoadmapStep component to detect applying state
- [x] Added hourglass emoji and applying message UI
- [x] Updated CTA text logic based on step state
- [x] Updated navigation function for proper routing
- [x] Wrote unit tests for state detection logic
- [x] Wrote integration tests for state transitions
- [x] Ran all tests and validations

### Files Modified

- `/lib/queries/roadmap-queries.ts` - Added application logs fetching to detect reflections
- `/lib/transformers/roadmap-transformers.ts` - Added has_reflection and plan_created_at fields to transformed step
- `/components/features/roadmap/RoadmapStep.tsx` - Added applying state detection, UI elements, and dynamic CTA text
- `/components/features/roadmap/__tests__/RoadmapStep.test.tsx` - Added comprehensive unit tests
- `/tests/integration/roadmap-applying-state.test.tsx` - Added integration tests for state transitions

### Completion Notes

- Successfully implemented applying state indicator with hourglass emoji
- CTA text dynamically changes based on step state (has plan, has reflection)
- Navigation logic updated to route to correct screen based on state
- All tests passing, linting clean, TypeScript checks pass
- Mobile responsive design maintained

### Status

Ready for Review
