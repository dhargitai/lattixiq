# Story 2.4: Implement Reminder Notification System

## Status

Draft

## Story

**As a** user with an active plan (implementation intention or spotting mission)
**I want** to receive a daily reminder at my chosen time
**So that** I remember to practice and don't lose momentum in applying what I've learned

## Acceptance Criteria

1. Users can set a global reminder preference with time selection
2. Daily notifications are sent at the user's chosen time
3. Reminder includes a summary of their current active plan
4. Notification opens the app directly to the reflect screen for that step
5. Users can disable reminders at any time through settings
6. System works reliably on both mobile and desktop
7. Handles timezone considerations properly
8. Only sends reminders for steps with active plans (plan_created_at exists)
9. Uses web push notifications as primary method with email fallback
10. Reminder content is personalized based on plan type (mental model vs bias)
11. No duplicate notifications sent on the same day
12. System respects user's notification permissions

## Tasks / Subtasks

- [ ] Task 1: Write integration tests using TDD approach (AC: 1-12)
  - [ ] Create test file at `/app/api/notifications/__tests__/notifications.test.ts`
  - [ ] Write test for setting notification preferences
  - [ ] Write test for scheduling daily reminders
  - [ ] Write test for notification content personalization
  - [ ] Write test for timezone handling
  - [ ] Write test for duplicate prevention
  - [ ] Write test for permission checking
  - [ ] Write test for active plan filtering
  - [ ] Write test for disabling notifications
- [ ] Task 2: Design notification preference data structure (AC: 1, 5, 7)
  - [ ] Define `NotificationPrefs` interface in types:
    ```typescript
    interface NotificationPrefs {
      reminders_enabled: boolean;
      reminder_time: string; // HH:MM format (24-hour)
      timezone: string; // IANA timezone identifier
      last_notification_date: string | null; // ISO date string
    }
    ```
  - [ ] Update user types to include typed notification preferences
  - [ ] Create validation schemas for notification preferences
- [ ] Task 3: Create notification settings UI component (AC: 1, 5)
  - [ ] Create `/components/features/settings/NotificationSettings.tsx`
  - [ ] Add time picker component for reminder time selection
  - [ ] Add timezone detection and selection
  - [ ] Implement enable/disable toggle with proper states
  - [ ] Add form validation and submission handling
  - [ ] Follow component template pattern with forwardRef
- [ ] Task 4: Set up notification service architecture (AC: 2, 6, 9)
  - [ ] Create `/lib/services/notification-service.ts` abstraction layer
  - [ ] Implement web push notification setup:
    - VAPID key generation and configuration
    - Service worker registration
    - Push subscription management
  - [ ] Add email notification fallback using existing email service
  - [ ] Create notification templates for different plan types
  - [ ] Handle notification permission requests gracefully
- [ ] Task 5: Implement notification scheduling system (AC: 2, 3, 7, 8, 11)
  - [ ] Create `/app/api/notifications/schedule/route.ts` API endpoint
  - [ ] Implement Supabase Edge Function for scheduled notifications:
    ```typescript
    // supabase/functions/send-reminders/index.ts
    // Triggered daily by cron job
    ```
  - [ ] Create logic to:
    - Query users with reminders enabled
    - Filter for users in correct timezone window
    - Find active plans (steps with plan_created_at but no reflection)
    - Generate personalized notification content
    - Send notifications and update last_notification_date
  - [ ] Add duplicate prevention using last_notification_date
- [ ] Task 6: Create notification content templates (AC: 3, 4, 10)
  - [ ] Design notification templates in `/lib/templates/notification-templates.ts`:
    - Mental model reminders: "Time to practice [Model Name]"
    - Bias spotting reminders: "Time to watch for [Bias Name]"
    - Body text with plan situation summary
    - Action button/link to reflect screen
  - [ ] Implement deep linking to `/reflect/[stepId]` route
  - [ ] Add personalization based on user's plan details
  - [ ] Create fallback content for edge cases
- [ ] Task 7: Build reflection screen routing (AC: 4)
  - [ ] Create placeholder `/app/(app)/reflect/[stepId]/page.tsx` route
  - [ ] Add authentication check and step validation
  - [ ] Implement "Coming from notification" detection
  - [ ] Add proper loading states and error handling
  - [ ] Ensure route handles direct access from notifications
- [ ] Task 8: Add notification preferences to user settings (AC: 1, 5)
  - [ ] Create settings page or modal for notification preferences
  - [ ] Integrate NotificationSettings component
  - [ ] Add API routes for updating notification preferences:
    ```typescript
    // PATCH /api/users/preferences
    ```
  - [ ] Handle initial setup flow for new users
  - [ ] Add proper success/error feedback
- [ ] Task 9: Implement service worker for web push (AC: 6, 9)
  - [ ] Create `/public/sw.js` service worker
  - [ ] Register service worker in app layout
  - [ ] Handle push event listeners
  - [ ] Implement notification click handling for deep linking
  - [ ] Add offline notification queueing if needed
- [ ] Task 10: Set up cron scheduling infrastructure (AC: 2, 7)
  - [ ] Configure Supabase Edge Function with cron trigger:
    ```sql
    SELECT cron.schedule(
      'send-daily-reminders',
      '0 */1 * * *', -- Every hour to handle timezones
      'SELECT net.http_post(url := ''https://[project].supabase.co/functions/v1/send-reminders'')'
    );
    ```
  - [ ] Add monitoring and error handling for scheduled tasks
  - [ ] Test cron scheduling in staging environment
  - [ ] Add logging for notification delivery tracking
- [ ] Task 11: Polish and testing (AC: 1-12)
  - [ ] Add comprehensive error handling and retry logic
  - [ ] Implement proper loading states in UI
  - [ ] Add analytics tracking for notification engagement
  - [ ] Test notification delivery across different devices/browsers
  - [ ] Verify timezone handling with users in different zones
  - [ ] Add accessibility features (screen reader support, keyboard navigation)
  - [ ] Performance testing for notification scheduling at scale

## Dev Notes

### Previous Story Insights

From Story 2.2 and 2.3 (Plan Screens):

- Plans are stored in `roadmap_steps` table with fields: `plan_situation`, `plan_trigger`, `plan_action`, `plan_created_at`
- Plans exist for both mental models (implementation intentions) and cognitive biases/fallacies (spotting missions)
- Navigation flow established: Learn → Plan → (Reminder) → Reflect
- Different content types require different notification messaging

From Epic 2 requirements:

- Story 2.4 has highest complexity (13 story points) and is identified as critical path
- Notification delivery reliability is a key risk area
- Success metric: 50% of users should enable reminders

### Architecture Requirements

**Notification Service Design:**
Following architecture/5-system-components.md:

- Create abstraction layer to avoid vendor lock-in
- Use simple internal `sendEmail` and `sendPush` functions
- Support both web push and email notifications

**Database Integration:**

- Users table has `notification_prefs` JSONB field for preferences
- Use `plan_created_at` timestamp to identify active plans
- Track `last_notification_date` to prevent duplicates

**Technical Approach:**

- **Primary:** Web Push Notifications with service worker
- **Fallback:** Email notifications for better reliability
- **Scheduling:** Supabase Edge Functions with cron triggers
- **Timezone:** Handle multiple timezones by running hourly checks

### Data Models

**Notification Preferences Interface:**

```typescript
interface NotificationPrefs {
  reminders_enabled: boolean;
  reminder_time: string; // "09:00" format
  timezone: string; // "America/New_York"
  last_notification_date: string | null; // "2025-08-04"
  push_subscription?: PushSubscription; // For web push
  email_fallback_enabled: boolean;
}
```

**Active Plan Query Pattern:**

```typescript
// Find users with active plans ready for reminders
const usersWithActivePlans = await supabase
  .from("roadmap_steps")
  .select(
    `
    *,
    roadmap:roadmaps!inner(user_id),
    knowledge_content(*),
    users!inner(notification_prefs)
  `
  )
  .not("plan_created_at", "is", null) // Has a plan
  .is("application_logs.id", null) // No reflection yet
  .eq("users.notification_prefs->reminders_enabled", true);
```

### Notification Content Templates

**Mental Model Reminder:**

- Title: "Time to practice [Model Name]"
- Body: "Remember your plan: [situation summary]"
- Action: "Reflect on your experience"

**Bias Spotting Reminder:**

- Title: "Watch for [Bias Name] today"
- Body: "Your mission: [situation summary]"
- Action: "Log what you spotted"

### Technical Implementation

**Web Push Setup:**

```typescript
// Generate VAPID keys for push notifications
// Store in environment variables:
// NEXT_PUBLIC_VAPID_PUBLIC_KEY
// VAPID_PRIVATE_KEY
```

**Service Worker Pattern:**

```javascript
// /public/sw.js
self.addEventListener("push", (event) => {
  const data = event.data.json();
  const options = {
    body: data.body,
    icon: "/icon-192x192.png",
    badge: "/badge-72x72.png",
    actions: [
      {
        action: "reflect",
        title: "Reflect Now",
      },
    ],
    data: {
      url: data.url, // Deep link to reflect screen
    },
  };

  event.waitUntil(self.registration.showNotification(data.title, options));
});
```

**Supabase Edge Function Structure:**

```typescript
// supabase/functions/send-reminders/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

serve(async (req) => {
  // 1. Get current time and determine timezone windows
  // 2. Query users with notifications enabled in target timezones
  // 3. Filter for active plans without reflections
  // 4. Generate personalized notification content
  // 5. Send push notifications + email fallbacks
  // 6. Update last_notification_date
  // 7. Log results for monitoring
});
```

### Route Structure

New routes to be created:

```text
/app/api/notifications/
├── preferences/
│   └── route.ts           # GET/PATCH user notification preferences
├── schedule/
│   └── route.ts          # POST to manually trigger notification scheduling
└── subscribe/
    └── route.ts          # POST to register push subscription

/app/(app)/settings/
└── notifications/
    └── page.tsx          # Notification settings UI

/app/(app)/reflect/[stepId]/
└── page.tsx              # Reflection screen (placeholder for now)

/supabase/functions/
└── send-reminders/
    └── index.ts          # Scheduled notification sender
```

### Component Architecture

**NotificationSettings Component:**

```typescript
interface NotificationSettingsProps extends React.HTMLAttributes<HTMLDivElement> {
  initialPreferences?: NotificationPrefs;
  onPreferencesUpdate?: (prefs: NotificationPrefs) => void;
}

const NotificationSettings = React.forwardRef<HTMLDivElement, NotificationSettingsProps>(
  ({ initialPreferences, onPreferencesUpdate, className, ...props }, ref) => {
    // Time picker, timezone selector, enable/disable toggle
  }
);
```

### Testing Strategy

**Unit Tests:**

- Notification content template generation
- Timezone conversion utilities
- Preference validation schemas

**Integration Tests:**

- API routes for preference management
- Notification scheduling logic
- Push subscription management

**E2E Tests:**

- Complete notification flow from plan creation to reminder delivery
- Settings UI interaction
- Cross-browser push notification compatibility

### Security Considerations

**Push Notifications:**

- Validate push subscriptions before storing
- Use VAPID keys for authentication
- Sanitize notification content to prevent XSS

**Privacy:**

- Store minimal data in notification payloads
- Respect user's notification permissions
- Allow easy opt-out mechanisms

### Performance Considerations

**Batch Processing:**

- Process notifications in batches to handle scale
- Use database pagination for large user queries
- Implement rate limiting for notification API

**Caching:**

- Cache notification templates
- Use efficient queries with proper indexes
- Monitor Edge Function execution time

### File Locations

**To be created:**

- `/app/api/notifications/preferences/route.ts` - Notification preference API
- `/app/api/notifications/schedule/route.ts` - Manual scheduling trigger
- `/app/api/notifications/subscribe/route.ts` - Push subscription management
- `/app/(app)/settings/notifications/page.tsx` - Settings UI
- `/app/(app)/reflect/[stepId]/page.tsx` - Reflection route placeholder
- `/components/features/settings/NotificationSettings.tsx` - Settings component
- `/lib/services/notification-service.ts` - Service abstraction
- `/lib/templates/notification-templates.ts` - Content templates
- `/public/sw.js` - Service worker for push notifications
- `/supabase/functions/send-reminders/index.ts` - Scheduled reminder function

**To be modified:**

- `/lib/supabase/types.ts` - Add NotificationPrefs interface
- `/app/layout.tsx` - Register service worker
- User settings navigation - Add link to notification settings

### Technical Constraints

- Next.js 15.4.5 with App Router
- React 19.1.0
- TypeScript with strict mode
- Supabase for backend and Edge Functions
- Web Push API for notifications
- VAPID for push authentication

[Source: architecture/2-tech-stack.md#Frontend Stack]

### Risk Mitigation

**Notification Delivery:**

- Implement email fallback for failed push notifications
- Add retry logic with exponential backoff
- Monitor delivery rates and failure patterns

**Cross-Platform Support:**

- Test on major browsers (Chrome, Firefox, Safari, Edge)
- Handle iOS Safari limitations with push notifications
- Provide clear messaging about notification support

**Timezone Handling:**

- Use IANA timezone identifiers for accuracy
- Handle daylight saving time transitions
- Test with users in different global timezones

### Success Metrics

- 50% of users enable notifications (Epic success criteria)
- > 90% notification delivery rate
- <5% unsubscribe rate
- Increased engagement with reflect screen from notifications

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-08-04 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent_

### Debug Log References

_To be populated by Dev Agent_

### Completion Notes List

_To be populated by Dev Agent_

### File List

_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_
